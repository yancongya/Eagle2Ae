class CollectWindowIframe{iframe;dialog;isReady=!1;constructor(e){this.meta=JSON.parse(JSON.stringify(e));var e=jQuery(`<iframe id="eagle-extension-collect-window" src="${eagle.extension.path}collect-window/index.html"></iframe>`),l=jQuery('<dialog id="eagle-extension-collect-dialog" eagle-extension></dialog>');return l.append(e),l.appendTo("body"),this.dialog=l[0],this.iframe=e[0],document.body.classList.add("eagle-show-collect-window"),l[0].showModal(),this.isReady=!1,this.#setupReadyListener(),this}#setupReadyListener(){let l=window.addEventListener("message",e=>{e.source===this.iframe.contentWindow&&"iframe-ready"===e.data.channel&&(this.isReady=!0,window.removeEventListener("message",l))})}sendMessage(e){this.iframe.contentWindow.postMessage(e,"*")}#sendMeta(){this.sendMessage({channel:"preview-meta",...this.meta})}async loaded(){return this.isReady?Promise.resolve():new Promise(e=>{const l=()=>{this.isReady?(this.#sendMeta(),e()):setTimeout(l,100)};l()})}remove(){this.dialog.close(),document.body.removeChild(this.dialog),document.body.classList.remove("eagle-show-collect-window")}}class CollectWindow{collectWindowIframe;listener;static MAX_PREVIEW_WIDTH=207;constructor(){this.collectWindowIframe=null,this.#registerEventListener()}async open(l){this.collectWindowIframe||(this.collectWindowIframe=new CollectWindowIframe(l),await this.collectWindowIframe.loaded(),this.collectWindowIframe.iframe.focus(),this.#waitForCollectItem().then(e=>{l.onCollect&&l.onCollect(e)}).catch(()=>{l.onCancel&&l.onCancel()}))}close(){this.collectWindowIframe&&this.collectWindowIframe.remove(),this.collectWindowIframe=null,this.listener&&window.removeEventListener("message",this.listener)}#waitForCollectItem(){return new Promise((t,a)=>{this.listener=window.addEventListener("message",e=>{if("collect-item"===e.data.channel){var l=e.data.result;if(l.folderID)throw new Error("choose");eagle.env.shouldShowNewCollectWindow()&&(l.forceOpenCollectModal=void 0,l.forceHideCollectModal=!0),t(l),window.removeEventListener("message",this.listener),this.close()}else"iframe-closed"===e.data.channel&&(a(),this.close())})})}#registerEventListener(){window.addEventListener("message",async e=>{if(this.collectWindowIframe&&!1!==e.isTrusted&&e.source===this.collectWindowIframe.iframe.contentWindow&&e.data.channel){var l=e.data.channel;if("open-create-folder-dialog"===l){var t=eagle.utils.deepClone(e.data.collectItem),a=e.data.parent,o=e.data.item,o=await eagle.dialog.showCreateFolderDialog(o?.name?.trim()||"");null==o?this.collectWindowIframe.sendMessage({channel:"cancel-create-folder-dialog"}):""==o.trim()?alert("please input folder name"):(o=await eagle.folder.create(o,a),t.folderIDs=[o.id],window.postMessage({channel:"collect-item",result:t}),this.close())}else if("collectWindow.covertToBase64"==l){const{src:s,thumbnail:n}=e.data,i=(await eagle.urlEnlarger.enlargeWithoutCheckEagleHasAbility(s))["largeUrl"];i?(a=await new Promise(l=>{eagle.downloader.download({url:i,thumbnailURL:n||s,silence:!0,onComplete:async e=>{l(e.base64)}})}),this.collectWindowIframe.sendMessage({channel:"collectWindow.covertToBase64Response",src:s,base64:a},"*")):(o=await new Promise(l=>{eagle.downloader.download({url:s,silence:!0,onComplete:async e=>{l(e.base64)}})}),this.collectWindowIframe.sendMessage({channel:"collectWindow.covertToBase64Response",src:s,base64:o},"*"))}else if("collectWindow.enlargeUrl"==l){const{src:c,thumbnail:r}=e.data,d=(await eagle.urlEnlarger.enlargeWithoutCheckEagleHasAbility(c))["largeUrl"];d?(t=await new Promise(l=>{eagle.downloader.download({url:d,thumbnailURL:r||c,silence:!0,onComplete:async e=>{l(e.base64)}})}),this.collectWindowIframe.sendMessage({channel:"collectWindow.enlargeUrlResponse",src:c,base64:t},"*")):this.collectWindowIframe.sendMessage({channel:"collectWindow.enlargeUrlResponse",src:c,base64:null},"*")}}})}updateTheme(){this.collectWindowIframe&&this.collectWindowIframe.contentWindow.postMessage({channel:"update-theme"},"*")}}eagle.collectWindow=new CollectWindow;