class ElementInspector{selectedElement;selectedLink;static getTarget(){return this.selectedElement}static setTarget(e){this.selectedElement=null,this.selectedLink=null;var t=e.target===window.document.documentElement,r="mousedown"===e.type,i=!(e.target instanceof SVGElement||e.target instanceof HTMLElement);!r&&t||i||(r={x:e.clientX,y:e.clientY},this.selectedElement=this.getCollectableElementFromElement(e.target),this.selectedElement?(this.isLinkContainAcceptableElement(this.selectedElement)&&(t=this.getCollectableElementByPoint(r))&&({img:!0,video:!0,audio:!0,canvas:!0,picture:!0,svg:!0}[t.tagName.toLowerCase()]||t.hasAttribute("eagle-src"))&&(this.selectedElement=t),eagle.logger.info("[ElementInspector] get element directly success")):(this.selectedElement=this.getCollectableElementByPoint(r),this.selectedElement?eagle.logger.info("[ElementInspector] get element by point success"):eagle.logger.info("[ElementInspector] get element by point failed")))}static isAcceptableElement(e){if(e.hasAttribute("eagle-src"))return!0;if(e.hasAttribute("eagle-collectable"))return!0;var t=e.tagName.toLowerCase();if({picture:!0,svg:!0}[t])return!0;if("img"===t){const n=getComputedStyle(e).getPropertyValue("pointer-events");var r=""!=(e?.getAttribute("src")||e.currentSrc),i="none"===n;if(this.#isVisible(e)&&!this.#isAnnoyingImage(e)&&r&&!i)return!0}if("canvas"===t)return!!e.getContext("2d");if(("video"==t||"audio"==t)&&!e.currentSrc.startsWith("blob:"))return!0;"a"==t&&e.href&&"nofollow"!==e.rel&&(this.selectedLink=e.href);r=getComputedStyle(e).getPropertyValue("background-image");const n=getComputedStyle(e).getPropertyValue("pointer-events");i=getComputedStyle(e).getPropertyValue("background-repeat"),t="repeat"!==i&&"repeat-x"!==i&&"repeat-y"!==i,i=getComputedStyle(e).getPropertyValue("background-size"),i=i.includes("cover")||i.includes("contain")||i.includes("100%"),e=5<e.clientWidth&&5<e.clientHeight;if("none"!==r&&r.includes("url")&&"none"!==n&&e){if(i)return!0;if(t)return!0}return!1}static isLinkContainAcceptableElement(e){var t;return!("A"!==e.tagName||!e.href||(t=e.querySelector("img, video, canvas, picture, svg, [eagle-src]"),e="none"===getComputedStyle(e).getPropertyValue("pointer-events"),!t)||!this.#isVisible(t)||this.#isAnnoyingImage(t)||e)}static getCollectableElementFromElement(e){if(this.isAcceptableElement(e))return e;if(e instanceof SVGElement&&null!=e.closest("SVG"))return e.closest("SVG");if(e.hasAttribute("eagle-src"))return e;if("IMG"==e.tagName&&!this.#isAnnoyingImage(e)){if((e.hasAttribute("src")&&""!=e.getAttribute("src")||e.hasAttribute("srcset"))&&e?.getAttribute("src"))return e;var t=getComputedStyle(e).getPropertyValue("background-image"),r="none"!==t&&!t.includes("gradient")&&!t.includes("about:blank")&&!t.includes("overlay");if(this.#isAnnoyingImage(e)&&r){r=t.match(/url\("?(.+?)"?\)/);if(r&&r[1])return e}}if("VIDEO"==e.tagName){let t=(e.currentSrc||e.children[0].src).toLowerCase();if([".mp4",".webm","fbcdn.net","mime_type=video_mp4"].some(e=>t.includes(e))&&!t.includes("blob:"))return e}if("AUDIO"==e.tagName&&((e.currentSrc||e.children[0].src)&&!e.currentSrc.startsWith("blob:")))return e.currentSrc;var t=getComputedStyle(e).getPropertyValue("background-image"),r=getComputedStyle(e).getPropertyValue("background-repeat"),r="repeat"!==r&&"repeat-x"!==r&&"repeat-y"!==r,i="auto"!=getComputedStyle(e).getPropertyValue("background-size");if(r&&i&&("none"!==t&&!t.includes("gradient")&&!t.includes("about:blank")&&!t.includes("overlay"))){r=t.match(/url\("?(.+?)"?\)/);if(r&&r[1])return e}return null}static#getAllElementsFromPoint(e,t,r=document,i=new WeakMap){if(i.get(r))return[];i.set(r,!0);let n=[];var l,a,r=r.elementsFromPoint(e,t);if(0===r.length)return[];for(l of r)l.shadowRoot?(a=this.#getAllElementsFromPoint(e,t,l.shadowRoot,i),n.unshift(...a)):n.push(l);return n=[...new Set(n)]}static getCollectableElementByPoint(e){var t=this.#getAllElementsFromPoint(e.x,e.y,document).find(e=>this.isAcceptableElement(e));return t||this.#findAcceptedElementByPoint(e,$("img:visible"))}static getFilteredElementByPoint(e,t=()=>!0){return document.elementsFromPoint(e.x,e.y).filter(t)[0]}static#findAcceptedElementByPoint(e,t){let r=9999999,i=null;for(const s of t){var n=window.getComputedStyle(s),l=parseInt(n.width),a=parseInt(n.height),l=0<l&&0<a;0<parseFloat(n.opacity)&&"none"!==n.display&&"hidden"!==n.visibility&&l&&-1!==(a=this.#isPointInElement(s,e))&&a<r&&(i=s,r=a)}return i}static async getBase64FromBlobUrl(e){const r=await(await fetch(e)).blob(),i=new FileReader;return new Promise((e,t)=>{i.onloadend=()=>e(i.result),i.onerror=t,i.readAsDataURL(r)})}static async getMeta(e,{context:u="",parseBase64:t=!1}={}){if(null==e)return null;i=(r=e).getAttribute("eagle-src"),l=(r.getAttribute("eagle-tags")||"").split(",").map(e=>e.trim()).filter(e=>""!==e),n=r.getAttribute("eagle-type");var r,i={src:i&&eagle.utils.absolutePath(i),type:n,annotation:r.getAttribute("eagle-annotation"),tags:l||[],link:r.getAttribute("eagle-link"),title:eagle.utils.clearWeirdCharacters(r.getAttribute("eagle-title"))},n=await(async t=>{var e=t.tagName.toLowerCase(),r=getComputedStyle(t).getPropertyValue("background-image");let i={title:"",src:"",link:""};if(this.selectedLink&&(i.link=this.selectedLink),"canvas"===e?i.src=t.toDataURL():"svg"===e&&0<t.childElementCount?(n=(new XMLSerializer).serializeToString(t),n=btoa(unescape(encodeURIComponent(n))),i.src="data:image/svg+xml;base64,"+n):"img"===e&&("picture"===t?.parentElement?.tagName?.toLowerCase()&&(n=t.parentElement,n=this.#getPictureSourceSrc(n),i.src=n||t.currentSrc||t.getAttribute("src")),t.srcset&&(i.src=this.#getHighestResImgFromElement(t),i.thumbnailURL=this.#getLowestResImgFromElement(t)),"none"!==r&&r.includes("url")&&!r.includes("gradient")&&!r.includes("about:blank")&&!r.includes("overlay"))&&!0===t.complete&&t.naturalWidth<=5&&t.naturalHeight<=5&&t.naturalHeight<=t.clientHeight&&t.naturalWidth<=t.clientWidth&&(n=r.match(/url\("?(.+?)"?\)/))&&n[1]&&(i.src=n[1]),i.src||!t.currentSrc&&!t.getAttribute("src")||(i.src=t.currentSrc||t.getAttribute("src")),i.src||(n=t.querySelector("source"))&&(i.src=n.src),!i.src){let e;r.includes("image-set(")?(n=r.match(/image-set\((.+?)\)$/))&&(n=n[1].split(",").map(e=>e.trim().split(" ")[0]),i.src=n[n.length-1],e=i.src.match(/^url\(["']?(.+?)["']?\)$/)):e=r.match(/^url\(["']?(.+?)["']?\)$/),e&&e[1]&&(i.src=e[1],i.src.toLowerCase().includes("%3csvg")&&(i.src=decodeURIComponent(i.src)),i.src.includes("<svg"))&&i.src.includes("</svg>")&&(n=i.src.match(/<svg[\s\S]*?>[\s\S]*?<\/svg>/))&&(r=n[0]?.replaceAll("\\",""),n="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(r))),i.src=n)}i.src||(i.src=this.#getHighestResImgFromElement(t)),"img"===e&&i.src&&i.src.includes("blob:")&&(r=await this.getBase64FromBlobUrl(i.src),i.src=r);var n=$("a").has(t);if(0<n.length&&(e=location.href,r=n.attr("rel"),l=n.attr("target"),n=eagle.utils.absolutePath(n.attr("href")),eagle.utils.isValidUrl(n))&&("nofollow"!==r&&"noopener"!==r&&"_blank"!==l&&(i.link=n),eagle.utils.url.isSameHost(e,n)||eagle.utils.url.isSameRootDomain(e,n))&&(i.link=n),""==i.link){var r=t.getBoundingClientRect(),l=r.x+r.width/2,e=r.y+r.height/2,n=document.elementsFromPoint(l,e),l=n.find(e=>"a"===e.tagName.toLowerCase()),e=n.indexOf(t),n=n.indexOf(l);try{-1!==e&&-1!==n&&l&&n<e&&(c=l.getBoundingClientRect()).x<=r.x&&c.y<=r.y&&c.x+c.width>=r.x+r.width&&c.y+c.height>=r.y+r.height&&(i.link=l.href)}catch(e){}}var a,s,c,n=i.link===i.src,e=i.link&&i.src&&i.link.split("?")[0]===i.src.split("?")[0];(n||e||(e=>{e=e.split(".").pop();return["jpg","jpeg","png","gif","webp","bmp","svg","apng","avif"].includes(e)})(i.link)||""==i.link)&&(i.link=location.href);try{const o=eagle.plugin.get(i.link);o&&(o.getMeta&&(a=o.getMeta(t),i={...i,...a}),"batchSaver"!==u||"batchSaver"===u&&!o.disableBatchSaver)&&o.getMetaAsync&&(s=await eagle.utils.raceAbort([e=>o.getMetaAsync(t),r=>new Promise(e=>{const t=setTimeout(()=>{e({})},1e4);r.addEventListener("abort",()=>{clearTimeout(t),e({})})})]),i={...i,...s})}catch(e){}i.type||(c=t.tagName.toLowerCase(),i.type=["video","audio"].includes(c)?c:"image"),i.src=eagle.utils.absolutePath(i.src),i.thumbnailURL&&(i.thumbnailURL=eagle.utils.absolutePath(i.thumbnailURL));r=[i.customTitle,i.title,this.#getBestTitle(t),document.title,"untitled"];return i.title=r.find(e=>0<eagle.utils.clearWeirdCharacters(e).length),i})(e),l={src:i.src||n.src,thumbnailURL:i.src||n.thumbnailURL||n.src,annotation:i.annotation||n.annotation,tags:i.tags||[],url:i.link||n.link,title:i.title||n.title,elementType:i.type||n.type};return l.src&&l.src.startsWith("blob:")?null:(!t||eagle.preference.downloadViaBrowser||"img"!==e.tagName.toLowerCase()||e.hasAttribute("eagle-src")||(r=await eagle.cacheHelper.toDataURL(l.src))&&(l.base64=r),l)}static#isPointInElement(e,t){var r=e.getBoundingClientRect(),i=1,n=1,l=t.x,t=t.y;return r.y+r.height<t||r.y>t+n||r.x+r.width<l||r.x>l+i?-1:0<=(n=this.#getZIndex(e))?Math.sqrt(Math.pow(r.x-l,2)+Math.pow(r.y-t,2))-1e3*n:Math.sqrt(Math.pow(r.x-l,2)+Math.pow(r.y-t,2))}static#getZIndex(e){var t;return e==document?0:(t=document.defaultView.getComputedStyle(e).getPropertyValue("z-index"),isNaN(t)?this.#getZIndex(e.parentNode):parseInt(t))}static#isVisible(e){return!!e&&"0px"!==(e=getComputedStyle(e)).width&&"0px"!==e.height&&"0"!==e.opacity&&"none"!==e.display&&"hidden"!==e.visibility}static#isAnnoyingImage(e){var t;return!!e&&("IMG"!==e.tagName||!1!==e.complete)&&(t=e.naturalWidth,e=e.naturalWidth,t<=5&&e<=5||t*e<10)}static#getPictureSourceSrc(t){let r="";{var i,n=e=>{r=0<e.length?this.#extractImageUrlsFromSourceSrcset(e)?.max:(e=t.querySelector("img"))?.currentSrc||e?.getAttribute("src")||""};let e=[...t.children];e=(e=e.filter(e=>"SOURCE"==e.tagName)).filter(e=>""==e.media||null==e.media);const l={"image/gif":1,"image/png":2,"image/jpeg":3,"image/jpg":3,"":4,undefined:4};n(e=(e=e.filter(e=>l[e.type])).sort((e,t)=>l[e.type]-l[t.type]))}return r}static#getHighestResImgFromElement(e){var t=e.currentSrc||e.getAttribute("src"),r=e.querySelectorAll("source");return 0<r.length?this.#extractImageUrlsFromSourceSrcset(r)?.max||t:(r=e.getAttribute("srcset"))&&this.#extractImageUrlsFromSrcset(r)?.max||t}static#getLowestResImgFromElement(e){var t=e.currentSrc||e.getAttribute("src"),r=e.querySelectorAll("source");return 0<r.length?this.#extractImageUrlsFromSourceSrcset(r)?.min||t:(r=e.getAttribute("srcset"))&&this.#extractImageUrlsFromSrcset(r)?.min||t}static#extractImageUrlsFromSourceSrcset(i){try{let e=null,t=null,r=0;for(var n of i){var l,a;n.hasAttribute("srcset")&&(l=n.getAttribute("srcset"),(a=this.#parseSrcsetString(l)).sort((e,t)=>null==e.width?1:null==t.width?-1:t.width-e.width),a[0].width>r&&(e=a[0].url,r=a[0].width),a[0].width<r)&&0<a[0].width&&(t=a[0].url)}return{max:e,min:t}}catch(e){return{max:null,min:null}}}static#extractImageUrlsFromSrcset(e){try{var t=this.#parseSrcsetString(e),r=eagle.utils.deepUnique(t);return r.sort((e,t)=>e.width<t.width||null==e.width?1:e.width>t.width||null==t.width?-1:0),{max:r[0].url,min:r[r.length-1].url}}catch(e){return{max:null,min:null}}}static#parseSrcsetString(e){return e.split(/\s*([^,]\S*[^,](?:\s+[^,]+)?)\s*(?:,|$)/).filter(e=>""!==e).map(e=>{let n={};return e.trim().split(/\s+/).forEach((e,t)=>{var r,i;0===t?n.url=e:(t=/^-?\d+$/,r=e.slice(0,-1),e=e[e.length-1],i=Number.parseInt(r,10),"w"===e&&t.test(r)?0<i&&(n.width=i):"x"===e&&t.test(r)&&0<i&&(n.width=i))}),n})}static#getBestTitle(t){let r=t&&(t.getAttribute("eagle-title")||t.customTitle||t.title)||t&&t.alt;try{r=r&&r.trim();let e=t.currentSrc||t?.getAttribute("src")||this.#getHighestResImgFromElement(t);if(e=e.split("?")[0],!r&&e&&-1<e.indexOf("."))try{var i;(r=decodeURIComponent(e).split("/").pop().replace(/\.[^.]*$/,""))&&(r=(r=(r=null===r.match(/[^a-zA-Z0-9 -_]/g)&&(i=r.split(/\d+/).length,1===r.split(" ").length)&&2<i?document.title:r).match(/^[a-zA-Z]+\d{4,}/g)?document.title:r).match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/g)?document.title:r).match(/^\d{5,}/g)&&(r=document.title),new RegExp("/[0-9a-f]{32}.|/[0-9a-f]{40}.","g").test(e)&&(r=document.title)}catch(e){}return location.href===e&&(r=new URL(e).pathname.split("/").pop(),r=decodeURIComponent(r)),r=(r="图片"===r||-1<r.indexOf("https://")?void 0:r)&&r!=parseInt(r)?r:document.title}catch(e){return r}}}eagle.elementInspector=ElementInspector;