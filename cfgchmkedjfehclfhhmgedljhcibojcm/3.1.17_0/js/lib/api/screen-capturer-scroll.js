class ScreenCapturerScroll{#delay=500;#isScrolling=!1;#scrollElement=null;#getFloatingElementsInterval=null;#hiddenElements=[];#playingVideos=[];#screenCapturer;#onScroll=()=>{};#onScrollEnd=()=>{};constructor({screenCapturer:e,onScroll:t,onScrollEnd:i}){this.#screenCapturer=e,this.#delay=Math.max(1e3*eagle.preference.captureDelay,500),this.#onScroll=t,this.#onScrollEnd=i}start(n){if(!this.#isScrolling){this.#isScrolling=!0,document.documentElement.classList.add("eagle-scrolling");var l,o=this.#delay,r=(n||window.scrollTo(0,0),this.#scrollElement=this.#getMainScrollElement(),n&&(this.#scrollElement=document.documentElement),document.body),h=(this.#scrollElement&&this.#scrollElement!==document.documentElement?this.#scrollElement.scrollTop:l=window.scrollY,[document.documentElement.clientWidth,r?r.scrollWidth:0,document.documentElement.scrollWidth,r?r.offsetWidth:0,document.documentElement.offsetWidth]),d=[this.#scrollElement&&this.#scrollElement.clientHeight||0,this.#scrollElement&&this.#scrollElement.scrollHeight||0];let e=Math.max(...h);var h=Math.max(...d),d=window.innerWidth,s=window.innerHeight,c=[],g=s-(200<s?200:0),m=d;let t=h,i;if(this.#scrollElement&&this.#scrollElement!==document.documentElement||(document.documentElement.clientHeight,r&&r.scrollHeight,document.documentElement.scrollHeight,r&&r.offsetHeight,document.documentElement.offsetHeight),(e=e<=m+1?m:e)>window.innerWidth&&(e=window.innerWidth),document.documentElement.classList.add("hide-eagle-cropper"),document.documentElement.classList.add("eagle-capturing"),n)if(n.y>l&&n.y+n.height<l+s)c.unshift([0,l]),o=200;else for(t=n.y+n.height;t>n.y-g;)c.unshift([0,t]),t-=g;else for(;t>-g;){for(i=0;i<e;)c.unshift([i,t]),i+=m;t-=g}var r=c.length,u=jQuery("head title",window.parent.document),a=u.text();this.#scrollNext({scrollPositions:c,rect:n,windowHeight:s,windowWidth:d,fullWidth:e,fullHeight:h,numOfScrollPositions:r,$metaTitle:u,originTitle:a,originalY:l,delay:o})}}#scrollNext({scrollPositions:t,rect:i,windowHeight:n,windowWidth:l,fullWidth:o,fullHeight:r,numOfScrollPositions:h,$metaTitle:d,originTitle:s,originalY:c,delay:g}){const m=()=>{d.text(s),document.documentElement.classList.remove("eagle-scrolling"),document.documentElement.classList.remove("eagle-capturing"),this.#scrollElement&&this.#scrollElement!==document.documentElement?this.#scrollElement.scrollTop=c:window.scrollTo(0,c),0==$("#screen-capturer-progress").length&&$("body").append('<div id="screen-capturer-progress"></div>'),clearTimeout(this.#getFloatingElementsInterval),$("[eagle-scrolling-hidden]").removeAttr("eagle-scrolling-hidden"),this.#playingVideos.forEach(e=>{e.play()}),this.#playingVideos=[],$("#screen-capturer-progress").show(),this.#isScrolling=!1};var e,u,a;t.length?((e=t.shift())[0],e=e[1],i?this.#scrollElement&&this.#scrollElement!==document.documentElement||(u=jQuery(window).scrollTop())<i.y&&u+n>i.y+i.height&&i.height<n||window.scrollTo(0,e):this.#scrollElement&&this.#scrollElement!==document.documentElement?this.#scrollElement.scrollTop=e:window.scrollTo(0,e),(i&&i.height>n||!i)&&(t.length===h-1?this.#hiddenElements=this.#getAnnoyingElements():(this.#hiddenElements=this.#getFloatingElements(),this.#getFloatingElementsInterval=setTimeout(()=>{this.#getFloatingElements().forEach(e=>{$(e).attr("eagle-scrolling-hidden","true")})},200)),this.#hiddenElements.forEach(e=>{$(e).attr("eagle-scrolling-hidden","true")})),Array.from(document.querySelectorAll("video")).filter(e=>!e.paused).forEach(e=>{this.#playingVideos.push(e),e.pause()}),this.#playingVideos=[...new Set(this.#playingVideos)],u=(h-t.length)/h,a={x:window.scrollX,complete:u,windowWidth:l*eagle.screenCapturer.devicePixelInfo.devicePixelRatio,totalWidth:o*eagle.screenCapturer.devicePixelInfo.devicePixelRatio,totalHeight:r*eagle.screenCapturer.devicePixelInfo.devicePixelRatio,rect:i,numOfScrollPositions:h-t.length,pixelRatio:eagle.screenCapturer.devicePixelInfo.devicePixelRatio},eagle.logger.info(`[page] capture(${h-t.length}/${h})`),d.text(parseInt(100*u)+"% | "+s),this.#scrollElement&&this.#scrollElement!==document.documentElement?a.y=Math.round(this.#scrollElement.scrollTop):a.y=Math.round(window.scrollY),window.setTimeout(async()=>{var e=window.setTimeout(m,2e3),e=(window.clearTimeout(e),eagle.preference.captureFormat||"png"),e=await this.#screenCapturer.captureCurrentTab({format:e,quality:100});a.base64=e,this.#onScroll(a),this.#scrollElement&&t&&2<Math.abs(parseInt(this.#scrollElement.scrollTop)-a.y)?setTimeout(()=>{this.#scrollNext({scrollPositions:t,rect:i,windowHeight:n,windowWidth:l,fullWidth:o,fullHeight:r,numOfScrollPositions:h,$metaTitle:d,originTitle:s,originalY:c,delay:g})},1e3):this.#scrollNext({scrollPositions:t,rect:i,windowHeight:n,windowWidth:l,fullWidth:o,fullHeight:r,numOfScrollPositions:h,$metaTitle:d,originTitle:s,originalY:c,delay:g})},g)):m()}#getZIndex(e){var t;return e==document?0:(t=document.defaultView.getComputedStyle(e).getPropertyValue("z-index"),isNaN(t)?this.#getZIndex(e.parentNode):t)}#isElementVisible(t){try{var e=t.tagName.toLowerCase();if("html"===e||"body"===e)return!0;var i=getComputedStyle(t);if("none"!==i.display&&("visible"===i.visibility&&0!==i.opacity)){var n=t.getBoundingClientRect(),l=t.offsetWidth+t.offsetHeight+n.height+n.width;if(0!==l){var o={center:{x:t.getBoundingClientRect().left+t.offsetWidth/2,y:t.getBoundingClientRect().top+t.offsetHeight/2},"top-left":{x:t.getBoundingClientRect().left,y:t.getBoundingClientRect().top},"top-right":{x:t.getBoundingClientRect().right,y:t.getBoundingClientRect().top},"bottom-left":{x:t.getBoundingClientRect().left,y:t.getBoundingClientRect().bottom},"bottom-right":{x:t.getBoundingClientRect().right,y:t.getBoundingClientRect().bottom}};for(index in o){var r=o[index];if(r.x<0)return!1;if(r.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(r.y<0)return!1;if(r.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let e=document.elementFromPoint(r.x,r.y);if(null!==e)do{if(e===t)return!0}while(e=e.parentNode)}}}return!1}catch(e){return!0}}#getMainScrollElement(){for(var e=[],t=document.getElementsByTagName("*"),i=0;i<t.length;i++){var n=t[i];n.scrollHeight>n.clientHeight&&e.push({elem:n,scrollHeight:n.scrollHeight,clientHeight:n.clientHeight})}return e=e.filter(e=>{return!(e.clientHeight>window.innerHeight||e.elem&&"TEXTAREA"===e.elem.nodeName||!this.#isElementVisible(e.elem))&&((e=getComputedStyle(e.elem).overflow).includes("auto")||e.includes("scroll"))}),"hidden"!==getComputedStyle(document.documentElement).overflowY&&e.unshift({scrollHeight:document.documentElement.scrollHeight,clientHeight:document.documentElement.clientHeight,elem:document.documentElement}),0<(e=e.sort((e,t)=>{var i,n;return e.clientHeight===t.clientHeight&&e.scrollHeight!==t.scrollHeight?(i=parseInt(this.#getZIndex(e.elem)))<(n=parseInt(this.#getZIndex(t.elem)))?1:n<i?-1:0===i&&0===n?e.scrollHeight<t.scrollHeight?1:-1:0:e.scrollHeight<t.scrollHeight?1:e.scrollHeight>t.scrollHeight?-1:0})).length?e[0].elem:document.documentElement}#getFloatingElements(){var t=document.getElementsByTagName("*"),i=[];for(let e=0;e<t.length;e++){var n=t[e],l=getComputedStyle(n),o=l.position,l="0"!==l.width&&"0"!==l.height&&"0"!==l.opacity&&"none"!==l.display&&"hidden"!==l.visibility,o=o.includes("fixed")||o.includes("sticky");l&&o&&i.push(n)}let c=[],g=window.innerHeight*window.innerWidth;return i.forEach(e=>{var t,i,n,l,o,r,h,d,s=jQuery(e);this.#isElementInViewport(e)&&s.is(":visible")&&(d=getComputedStyle(e),t=s.height()*s.width()<.2*g&&10<s.position().top&&s.width()<.8*window.innerWidth&&e.clientHeight<window.innerHeight,i="0px"===d.right&&"0px"===d.top&&s.height()===window.innerHeight&&s.width()<.3*window.innerWidth,n="0px"===d.bottom&&"0px"!==d.top&&e.clientHeight<window.innerHeight&&"100%"!==d.height,l="fixed"===d.position&&"0px"===d.top&&"100%"!==d.height&&e.clientHeight>window.innerHeight,s=s.height()<100&&s.width()<100&&s.height()*s.width()<5625&&e.clientHeight<window.innerHeight,o="fixed"===d.position&&d.top.replace("px","").includes("-"),r="fixed"===d.position&&"0px"==d.left&&"0px"===d.bottom&&"100%"!==d.height&&e.clientHeight<window.innerHeight&&("100%"===d.width||e.clientWidth==window.innerWidth),h="fixed"===d.position&&"0px"==d.top&&"0px"==d.right&&d.height.replace("px","")==e.clientHeight&&e.clientHeight==window.innerHeight,d="fixed"===d.position&&d.left===d.right,!(t||i||n||s||o||l||r||h||d)||.7<e.clientWidth*e.clientHeight/(window.innerWidth*window.innerHeight)||c.push(e))}),c}#getAnnoyingElements(){var t=document.getElementsByTagName("*"),i=[];for(let e=0;e<t.length;e++){var n=t[e],l=getComputedStyle(n),o=l.position;"0"!==l.width&&"0"!==l.height&&"0"!==l.opacity&&"none"!==l.display&&"hidden"!==l.visibility&&(o.includes("fixed")||o.includes("sticky"))&&i.push(n)}let s=[],c=window.innerHeight*window.innerWidth;return i.forEach(e=>{var t,i,n,l,o,r,h,d=$(e);this.#isElementInViewport(e)&&d.is(":visible")&&(h=getComputedStyle(e),t=d.height()*d.width()<.2*c&&10<d.position().top&&d.width()<.8*window.innerWidth&&e.clientHeight<window.innerHeight,i="0px"===h.right&&"0px"===h.top&&d.height()===window.innerHeight&&d.width()<.3*window.innerWidth,n="0px"===h.bottom&&"0px"!==h.top&&$("body").width()===d.width()&&d.height()<.3*window.innerHeight,d=d.height()<100&&d.width()<100&&d.height()*d.width()<5625&&e.clientHeight<window.innerHeight,l="fixed"===h.position&&h.top.replace("px","").includes("-"),o="fixed"===h.position&&"0px"===h.top&&"100%"!==h.height&&e.clientHeight>window.innerHeight,r="fixed"===h.position&&"0px"==h.left&&"0px"===h.bottom&&"100%"!==h.height&&e.clientHeight<window.innerHeight&&("100%"===h.width||e.clientWidth==window.innerWidth)&&""===h.overflowY,h="fixed"===h.position&&"0px"==h.top&&"0px"==h.right&&h.height.replace("px","")==e.clientHeight&&e.clientHeight==window.innerHeight,!(t||i||n||d||l||o||r||h)||.7<e.clientWidth*e.clientHeight/(window.innerWidth*window.innerHeight)||s.push(e))}),s}#isElementInViewport(e){var t;return!!e&&!!(e="function"==typeof jQuery&&e instanceof jQuery?e[0]:e)&&(t=0<=(e=e.getBoundingClientRect()).top+e.height&&0<=e.left&&e.bottom-e.height<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth),e=0===e.width&&0===e.height,t||e)}}