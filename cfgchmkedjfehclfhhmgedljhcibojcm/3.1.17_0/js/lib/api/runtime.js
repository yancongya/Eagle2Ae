class BaseRuntime{isAvailable=!0;sendMessage(e,n=0){throw new Error("No implementation for sendMessage")}connect(){throw new Error("No implementation for sendMessage")}getManifest(){throw new Error("No implementation for sendMessage")}}class ChromeRuntime extends BaseRuntime{constructor(){super(),this.onMessage=chrome.runtime.onMessage,this.connect=chrome.runtime.connect,this.onConnect=chrome.runtime.onConnect,this.getURL=chrome.runtime.getURL,this.getManifest=chrome.runtime.getManifest,this.getBackgroundPage=chrome.runtime.getBackgroundPage}#sendMessageInternal(s,r={},i,a=0){return new Promise((n,t)=>{try{chrome.runtime.sendMessage({channel:s,...r},e=>{if(chrome.runtime.lastError){if(!(a<3))throw new Error("retry sendMessage failed");setTimeout(()=>{this.#sendMessageInternal(s,r,i,a+1).then(n).catch(t)},2e3)}else i&&i(e),n(e)})}catch(e){"Extension context invalidated."!==e.message&&"retry sendMessage failed"!==e.message||(this.isAvailable=!1),n(null)}})}sendMessage(i,a={}){return new Promise(async e=>{var n=JSON.stringify(a);if(62914560<n.length){var t=20971520,s=Math.ceil(n.length/t);for(let e=0;e<s;e++){var r=n.slice(e*t,e*t+t);this.#sendMessageInternal(i,{type:"chunk",chunk:r,index:e})}e(await this.#sendMessageInternal(i,{type:"end",totalChunks:s}))}else e(await this.#sendMessageInternal(i,a))})}}class BrowserRuntime extends BaseRuntime{constructor(){super(),this.onMessage=browser.runtime.onMessage,this.onConnect=browser.runtime.onConnect,this.connect=browser.runtime.connect.bind(browser.runtime),this.getURL=browser.runtime.getURL.bind(browser.runtime),this.getManifest=browser.runtime.getManifest.bind(browser.runtime),browser.runtime.getBackgroundPage&&(this.getBackgroundPage=browser.runtime.getBackgroundPage.bind(browser.runtime))}sendMessage(o,h={},u){return new Promise(async(n,t)=>{var s=JSON.stringify(h);if(62914560<s.length){var r=20971520,i=Math.ceil(s.length/r);for(let e=0;e<i;e++){var a=s.slice(e*r,e*r+r);await browser.runtime.sendMessage({channel:o,type:"chunk",chunk:a,index:e})}var e=await browser.runtime.sendMessage({channel:o,type:"end",totalChunks:i});n(e)}else browser.runtime.sendMessage({channel:o,...h}).then(e=>{u&&u(e),n(e)}).catch(e=>t(e))})}}class Runtime{runtime=null;constructor(){if("undefined"!=typeof browser&&void 0!==browser.runtime)this.runtime=new BrowserRuntime;else{if("undefined"==typeof chrome||!chrome.runtime)throw new Error("Runtime not found.");this.runtime=new ChromeRuntime}this.connect=this.runtime.connect,this.onConnect=this.runtime.onConnect,this.getURL=this.runtime.getURL,this.getManifest=this.runtime.getManifest,2===this.getManifest.manifest_version&&(eagle.env.isBackground()?this.onConnect.addListener(()=>{}):this.runtime.connect().onDisconnect.addListener(()=>{this.runtime.isAvailable=!1}))}get isAvailable(){return this.runtime.isAvailable}receivedChunks=[];totalChunks=0;onMessageHandlerMap={};onMessage(r,i){this.onMessageHandlerMap[r]=i,this.runtime.onMessage.addListener((e,n,t)=>{var s;return e.channel===r&&("chunk"===e.type?(this.receivedChunks[e.index]=e.chunk,t("ok")):"end"===e.type?(this.totalChunks=e.totalChunks,this.receivedChunks.length===this.totalChunks&&(s=this.receivedChunks.join(""),i(JSON.parse(s),n,t),this.receivedChunks=[],this.totalChunks=0)):i(e,n,t)),!0})}offMessage(e){this.runtime.onMessage.removeListener(this.onMessageHandlerMap[e]),delete this.onMessageHandlerMap[e]}sendMessage(e,n={},t){return this.runtime.sendMessage(e,n,t)}async broadcast(n,t={}){(await eagle.tabs.query({})).forEach(e=>{eagle.tabs.sendMessage(e.id,n,t)}),eagle.runtime.sendMessage(n,t)}}eagle.runtime=new Runtime;