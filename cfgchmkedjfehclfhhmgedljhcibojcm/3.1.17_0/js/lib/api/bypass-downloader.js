class BypassBaseDownloader{async convertToBlobURL(e){throw new Error("Not implemented")}}class ForegroundBypassDownloader extends BypassBaseDownloader{constructor(){super()}convertToBlobURL(r){return new Promise((o,e)=>{var a=eagle.runtime.connect({name:Date.now().toString()});a.onMessage.addListener(e=>{switch(e.type){case"bypassDownloader.createIframe":this.createIframe(e.url);break;case"bypassDownloader.iframeResult":o({blobURL:e.data.blobURL,width:e.data.width,height:e.data.height,err:e.data.err||null})}}),a.onDisconnect.addListener(()=>{}),a.postMessage({type:"bypassDownloader.initIframe",url:r});setTimeout(()=>{e(new Error("download timeout"))},3e4)})}createIframe(e){var o=document.createElement("iframe");o.style="opacity: 0; pointer-events: none; position: absolute; top: 0; left: 0; width: 500px; height: 500px;",o.src=e,document.body.appendChild(o)}}class BackgroundBypassDownloader extends BypassBaseDownloader{onCompletedListenerMap={};constructor(){super();const r=this;this.onCompletedListenerMap={},chrome.runtime.onConnect.addListener(i=>{i.onMessage.addListener(async e=>{if("bypassDownloader.initIframe"===e.type){Date.now();const d=e.url;this.onCompletedListenerMap[d]=e=>{var o;e.url===d&&(o=e.tabId,e=e.frameId,chrome.runtime.onMessage.addListener(function e(o,a,r){var t,n,s;return"bypassDownloader.iframeFinish"===o.type&&o.url===d&&({blobURL:o,width:t,height:n,err:s}=o.data,r("ok"),i.postMessage({type:"bypassDownloader.iframeResult",data:{url:d,blobURL:o,width:t,height:n,err:s}}),chrome.runtime.onMessage.removeListener(e)),!0}),chrome.scripting.executeScript({target:{tabId:o,frameIds:[e]},func:()=>{fetch(location.href).then(e=>e.blob()).then(e=>{var e=URL.createObjectURL(e),o=document.querySelectorAll("body > img"),a=o[0];1!==o.length?chrome.runtime.sendMessage({type:"bypassDownloader.iframeFinish",url:location.href,data:{err:!0}}):(o=a.naturalWidth,a=a.naturalHeight,chrome.runtime.sendMessage({type:"bypassDownloader.iframeFinish",url:location.href,data:{blobURL:e,width:o,height:a}}),window.close())})}}))},i.postMessage({type:"bypassDownloader.createIframe",url:d})}}),i.onDisconnect.addListener(()=>{})}),chrome.webNavigation.onCompleted.addListener(function(e){var o=e.frameId,a=e.url;0!==o&&r.onCompletedListenerMap[a]&&(r.onCompletedListenerMap[a](e),delete r.onCompletedListenerMap[a])})}}class EagleBypassDownloader{#downloader;constructor(){!eagle.env.isBackground()||eagle.env.isPopup()||eagle.env.isCollectWindow()||eagle.env.isBatchSaverWindow()?this.#downloader=new ForegroundBypassDownloader:this.#downloader=new BackgroundBypassDownloader}convertToBlobURL(e){return this.#downloader.convertToBlobURL(e)}}eagle.bypassDownloader=new EagleBypassDownloader;