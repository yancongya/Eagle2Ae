class BaseDownloader{async fetch(e,t){throw new Error("Not implemented")}}class ForegroundDownloader extends BaseDownloader{tasks=new Map;$progress=null;constructor(){super(),this.$progress=null,this.queue=new eagle.Queue(async({url:n,type:e,thumbnailURL:t,onStarted:r,onProgress:s,onComplete:o,onError:a,silence:i=!1},d)=>{if(this.tasks.has(n)){const p=this.tasks.get(n);return r&&p.onStartCallbacks.push(r),s&&p.onProgressCallbacks.push(s),o&&p.onCompleteCallbacks.push(o),void(a&&p.onErrorCallbacks.push(a))}const l=(e,t)=>{clearTimeout(e?.timeout),e.timeout=setTimeout(()=>{e&&"complete"!==e.status.state&&"error"!==e.status.state&&(e.onErrorCallbacks&&e.onErrorCallbacks.forEach(e=>{e(new Error("error, timeout"))}),e.status.state="error",e.status.error="error, timeout",this.tasks.delete(e.url),this.renderProgress(),u.disconnect(),t())},3e4)},c=this.#generateUniqueId(),u=(this.tasks.set(n,{onStartCallbacks:r?[r]:[],onProgressCallbacks:s?[s]:[],onCompleteCallbacks:o?[o]:[],onErrorCallbacks:a?[a]:[],url:n,type:e,thumbnailURL:t,silence:i,status:{progress:0,state:"pending",error:null,data:null}}),eagle.runtime.connect({name:c})),p=(u.onMessage.addListener(t=>{var e=this.tasks.get(n);if(e)switch(t.type){case"downloadStarted":e.onStartCallbacks&&e.onStartCallbacks.forEach(e=>{e()}),e.status.state="in_progress",this.renderProgress();break;case"downloadProgress":{const o=t.progress?parseInt(t.progress):0;e.onProgressCallbacks&&e.onProgressCallbacks.forEach(e=>{e&&e(o)}),e.status.progress=o,l(e,d),this.renderProgress();break}case"downloadResult":if("complete"===e.status.state||"error"===e.status.state)return;var{index:r,base64:s}=t.data;e.status.data=e.status.data||[],e.status.data[r]=s,l(e);break;case"downloadComplete":{const a={base64:e.status.data.join("")};e.onCompleteCallbacks&&e.onCompleteCallbacks.forEach(e=>{e(a)}),e.status.state="complete",e.status.progress=100,e.status.data=a,clearTimeout(e.timeout),this.renderProgress(),this.tasks.delete(n),document.getElementById("eagle-iframe-"+c)?.remove(),u.disconnect(),d();break}case"downloadError":e.onErrorCallbacks&&e.onErrorCallbacks.forEach(e=>{e(new Error(t.error))}),e.status.state="error",e.status.error=t.error,clearTimeout(e.timeout),this.renderProgress(),this.tasks.delete(n),u.disconnect(),d();break;case"downloadViaIframe":r=document.createElement("iframe");r.id="eagle-iframe-"+c,r.style="opacity: 0; pointer-events: none; position: absolute; top: 0; left: 0; width: 500px; height: 500px;",r.src=t.url,document.body.appendChild(r)}}),u.onDisconnect.addListener(()=>{var e=this.tasks.get(n);e&&(e.onErrorCallbacks&&e.onErrorCallbacks.forEach(e=>{e(new Error("error, connection disconnect"))}),e.status.state="error",e.status.error="error, connection disconnect",this.tasks.delete(n),this.renderProgress())}),u.postMessage({type:"download",url:n,identifier:c}),this.renderProgress(),this.tasks.get(n));l(p,d)},10)}download({url:e,type:t,thumbnailURL:r,onStarted:s,onProgress:o,onComplete:a,onError:n,silence:i=!1}){this.queue.push({url:e,type:t,thumbnailURL:r,onStarted:s,onProgress:o,onComplete:a,onError:n,silence:i})}#generateUniqueId(){return"download-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}renderProgress(){this.$progress||(this.$progress=jQuery(`
            <div class="eagle-downloader-progress-bar" eagle-extension eagle-extension-theme="${eagle.preference.displayTheme}" translate="no">
				<div class="eagle-downloader-progress-list"></div>
            </div>
        `),jQuery("body").append(this.$progress));var t,r,s=this.$progress.find(".eagle-downloader-progress-list");for([t,r]of this.tasks.entries())if(!r.silence){const e=s.find(`.eagle-downloader-task[task-id="${t}"]`);if(0<e.length){"complete"!==r.status.state&&"error"!==r.status.state||setTimeout(()=>{e.addClass("fade-out"),setTimeout(()=>{e.remove()},700)},500);var o=0===r.status.progress||100===r.status.progress?"":r.status.progress+"%";e.find(".eagle-downloader-progress-bar-message").html(eagle.i18n.words["downloader.downloading"]+` <span>${o}</span>`)}else{let e=null;e="video"===r.type?`<video src="${r.url}" autoplay="autoplay" loop muted></video>`:"audio"===r.type?"":`<img src="${r.thumbnailURL}"/>`;o=jQuery(`
				<div class="eagle-downloader-task" task-id="${t}">
					<div class="eagle-downloader-progress-bar-previewer">
						${e}
					</div>
					<div class="eagle-downloader-progress-bar-message">${eagle.i18n.words["downloader.downloading"]}</div>
				</div>
			`);s.prepend(o)}}}}class BackgroundDownloader extends BaseDownloader{onCompletedListenerMap={};timeout=null;#TIMEOUT=1e4;connectedPortMap={};constructor(){super();const s=this;this.onCompletedListenerMap={},eagle.runtime.onConnect.addListener(r=>{(this.connectedPortMap[r.name]=r).onMessage.addListener(async e=>{var t;"download"===e.type&&({url:e,identifier:t}=e,this.#startDownload({downloadURL:e,port:r,identifier:t}))}),r.onDisconnect.addListener(()=>{delete this.connectedPortMap[r.name]})}),chrome.webNavigation.onCommitted.addListener(function(e){var t=e.frameId,r=e.url;0!==t&&s.onCompletedListenerMap[r]&&(s.onCompletedListenerMap[r](e),delete s.onCompletedListenerMap[r])})}#postMessage(e,t){this.connectedPortMap[e.name]&&this.connectedPortMap[e.name].postMessage(t)}async#startDownload({downloadURL:e,port:r,identifier:s}){try{let t=await this.#downloadViaIframe(e,{port:r,identifier:s});var o=(t=t||await this.#downloadViaFetch(e,{port:r,identifier:s})).includes("image")||t.includes("video")||t.includes("octet-stream");if(t&&o){var a=[];for(let e=0;e<t.length;e+=62914560)a.push(t.slice(e,e+62914560));for(let e=0;e<a.length;e++)this.#postMessage(r,{type:"downloadResult",identifier:s,data:{index:e,base64:a[e]}});await new Promise(e=>setTimeout(e,100)),this.#postMessage(r,{type:"downloadComplete",identifier:s})}else this.#postMessage(r,{type:"downloadError",error:"Failed to download image",identifier:s})}catch(e){this.#postMessage(r,{type:"downloadError",error:"Failed to download image",identifier:s})}finally{this.timeout&&clearTimeout(this.timeout),delete this.onCompletedListenerMap[e]}}async#downloadViaFetch(g,{port:t,identifier:r}){const m=eagle.utils.throttle(e=>{this.#postMessage(t,{type:"downloadProgress",identifier:r,progress:e})},200,!0);return await eagle.utils.raceAbort([p=>new Promise(async(t,e)=>{p.addEventListener("abort",()=>t());try{var r=await fetch(g);if(!r.ok)return t();var s=r.headers.get("Content-Length"),o=r.headers.get("Content-Type"),a=r.body.getReader();let e=0;for(var n=[];;){var i,{done:d,value:l}=await a.read();if(d){m(100);break}n.push(l),e+=l.length,s&&(i=e/s*100,m(i))}var c=new Blob(n,{type:o||"application/octet-stream"});const u=new FileReader;u.onloadend=()=>{t(u.result)},u.onerror=()=>{t()},u.readAsDataURL(c)}catch(e){t()}}),t=>new Promise(e=>{this.timeout=setTimeout(()=>{e()},this.#TIMEOUT),t.addEventListener("abort",()=>{clearTimeout(this.timeout),e()})})])}async#downloadViaIframe(n,{port:i,identifier:d}){return await eagle.utils.raceAbort([e=>new Promise(async a=>{e.addEventListener("abort",()=>a()),this.#postMessage(i,{type:"downloadViaIframe",identifier:d,url:n}),this.onCompletedListenerMap[n]=e=>{var t=e.tabId;if(e.url===n){var r=chrome.runtime.getURL("js/base64-extractor.js");chrome.scripting.executeScript({target:{tabId:t,frameIds:[e.frameId]},func:(e,t,r)=>{var s=document.createElement("script");s.id="eagle-script",s.src=e,s.setAttribute("data-download-url",t),document.body.appendChild(s);let o=setInterval(()=>{var e,t=document.querySelector("img, video, audio");t&&((e=t.getAttribute("data-base64"))?(clearInterval(o),eagle.runtime.sendMessage("newTabDownloaded-"+r,{url:location.href,data:{base64:e}})):(e=t.getAttribute("data-progress"))&&eagle.runtime.sendMessage("newTabDownloaded-progress-"+r,{url:location.href,percentComplete:parseInt(e)}))},50)},args:[r,n,d]});const s="newTabDownloaded-"+d,o="newTabDownloaded-progress-"+d;eagle.runtime.onMessage(s,(e,t,r)=>{return e.url===n&&(e.percentComplete&&(this.timeout&&clearTimeout(this.timeout),this.#postMessage(i,{type:"downloadProgress",identifier:d,progress:100})),e=e.data.base64,r("ok"),eagle.runtime.offMessage(s),eagle.runtime.offMessage(o),a(e)),!0}),eagle.runtime.onMessage(o,(e,t,r)=>(e.url===n&&(this.timeout&&clearTimeout(this.timeout),this.#postMessage(i,{type:"downloadProgress",identifier:d,progress:e.percentComplete})),!0))}}}),t=>new Promise(e=>{this.timeout=setTimeout(()=>{e()},this.#TIMEOUT),t.addEventListener("abort",()=>{clearTimeout(this.timeout),e()})})])}}class EagleDownloader{#downloader;constructor(){!eagle.env.isBackground()||eagle.env.isPopup()||eagle.env.isCollectWindow()||eagle.env.isBatchSaverWindow()?this.#downloader=new ForegroundDownloader:this.#downloader=new BackgroundDownloader}download({url:e,type:t,thumbnailURL:r,onStarted:s,onProgress:o,onComplete:a,onError:n,silence:i=!1}){this.#downloader.download({url:e,type:t,thumbnailURL:r,onStarted:s,onProgress:o,onComplete:a,onError:n,silence:i})}renderProgress(){this.#downloader.renderProgress()}}eagle.downloader=new EagleDownloader;