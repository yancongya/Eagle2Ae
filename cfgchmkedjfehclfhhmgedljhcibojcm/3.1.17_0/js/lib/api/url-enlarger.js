globalThis.URLEnlarger=class{#ruleValidMap={};rules=[{site:"Reddit",srcPattern:"https://preview.redd.it/(.*)",replace:e=>{return e.split("?")[0].replace("preview.redd.it","i.redd.it")}},{site:"deviantArt",srcPattern:/https:\/\/images\S+\.wixmp\.com\/f\/\S+\/v1\/fill\/\S+\?token\S+/,replace:e=>{var r,t=new URL(e).searchParams.get("token");return t&&(t=(e=>{e=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),e=decodeURIComponent(atob(e).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(e)})(t)).obj&&t.obj[0]&&t.obj[0][0]&&t.obj[0][0].height?(r=t.obj[0][0].height.replace("<=",""),t=t.obj[0][0].width.replace("<=",""),e.replace(/\/w_\d+,h_\d+,q_\d+/,`/w_${t},h_${r},q_100`)):e}},{site:"behance",srcPattern:/(.*)behance.net\/(project_modules|projects)\/(.*)/,replace:e=>{var r="/source/";return e.replace("/max_1200/",r).replace(/max_\d+/,r).replace("/2800_opt_1/",r).replace("/1400_opt_1/",r).replace("/disp/",r).replace(/project_modules\/\d+\//,`/project_modules/${r}/`).replace(/projects\/\d+\//,`/projects/${r}/`)}},{site:"imgur",srcPattern:/(.*)i\.imgur\.com\/(.*)/,replace:e=>e.replace(/\?(.*)/,"?maxwidth=99999")},{site:"twitter",srcPattern:/(.*)twimg.com(.*)name=(.*)/,replaceAsync:async s=>{const l=s;return s=s.replace(/name=(.*)/,"name=orig"),new Promise(r=>{const e=new AbortController;setTimeout(()=>e.abort(),3e3);var t=fetch(s.replace("format=webp","format=jpg"),{method:"HEAD",signal:e.signal}),a=fetch(s.replace("format=jpg","format=webp"),{method:"HEAD",signal:e.signal});Promise.all([t,a]).then(e=>200===e[0].status?r(e[0].url):200===e[1].status?r(e[1].url):r(l))})}},{site:"Bluesky",srcPattern:"https://cdn.bsky.app/img/feed_thumbnail/plain/(.*)@jpeg",replace:e=>e.replace("feed_thumbnail","feed_fullsize")},{site:"midjourney",srcPattern:"https://cdn.midjourney.com/(.*)",replace:e=>e.replace(/_\d+_N/,"").replace(/\.webp/,".png")},{site:"花瓣网 (v3)",srcPattern:"https://gd-hbimg.huaban(img)?.com/(.*)",replace:e=>e.replace(/_\/fw(.*)/,"").replace(/_sq\d+\/format(.*)/,"").split("/format/")[0].replace(/_sq235$/,"").replace(/_sq75$/,"").replace(/_sq(.*)$/,"").replace(/_fw[\d]+[w]*$/,"").split("_fw")[0].split("/fw/")[0]},{site:"花瓣网 (v2)",srcPattern:"(.*)hbimg.huaban.com/(.*)",replace:e=>e.replace(/_\/fw(.*)/,"").replace(/_sq\d+\/format(.*)/,"").split("/format/")[0].replace(/_sq235$/,"").replace(/_sq75$/,"").replace(/_sq(.*)$/,"").replace(/_fw[\d]+[w]*$/,"").split("_fw")[0].split("/fw/")[0]},{site:"花瓣网 (v1)",srcPattern:"//hbimg[.]*/*",replace:e=>e.split("/format/")[0].replace(/_sq235$/,"").replace(/_sq75$/,"").replace(/_fw[\d]+[w]*$/,"").split("_fw")[0].split("/fw/")[0]},{site:"大作",srcPattern:"(.*)bigurl(.*)",replace:e=>e.replace("pc_236_webp_2x","pc_680_webp").replace("pc_236_webp","pc_680_webp")},{site:"Lapa.ninja",srcPattern:"(.*)cdn.lapaninja.com(.*)",replace:e=>e.replace("-thumb.jpg",".jpg")},{site:"Dribbble",srcPattern:"https://cdn.dribbble.com/*",replace:e=>e.includes("userupload")||e.includes("screenshots")&&e.includes("media")?e.split("?")[0]:e.includes("screenshots")&&e.includes(".gif")?e.split("?")[0].replace("_4x",""):e.includes("/videos/")?e.replace("_large_preview",""):e.includes("/attachments/")?e:e.replace(/_1x/g,"").replace(/_teaser/g,"")},{site:"Pexels",srcPattern:"https?://images.pexels.com/*",replace:e=>e.split("?")[0]+"?auto=compress"},{site:"Tenor",srcPattern:"https://media.tenor.com/*",replace:e=>e.replace(/(d|M)\//,"C/")},{site:"新浪微博 weibo",srcPattern:/(.*)\/\/.*[.]sinaimg[.]cn\/([a-z]*)(\d+)\//,ignoreCheck:!0,replace:e=>e.includes(".mp4")?e:e.replace(/(cn)\/([a-z]*)(\d+)\//,"cn/large/")},{site:"百度贴吧",srcPattern:"https?://tiebapic[.]baidu[.]com/forum.*",replace:e=>{var r=e.match(/^(http:\/\/tiebapic\.baidu\.com\/forum\/)ab(pic\/item\/[\w.]+)/i);return/\/sys\/portrait/.test(e)?e.replace(/\/sys\/portrait/,"/sys/portraitl"):r?r[1]+r[2]:(r=e.match(/\/sign=\w+\/([\w.]+)$/))?"http://tiebapic.baidu.com/forum/pic/item/"+r[1]:e}},{site:"豆瓣相册",srcPattern:/https?:\/\/img[\d]*\.doubanio\.com\/.*/,replace:e=>e.replace(/[/]s[/]/,"/orginal/").replace(/[/]m[/]/,"/orginal/").replace(/[/]l[/]/,"/orginal/").replace(/[/]sqs[/]/,"/orginal/")},{site:"pixAI.Art",srcPattern:"https://images-ng.pixai.art/images/thumb/*",replace:e=>e.replace("/thumb/","/orig/")},{site:"Flickr",srcPattern:".*[.]staticflickr[.]com.*",replace:e=>e.replace(/_[nms]\.jpg$/,"_b.jpg")},{site:"颇可网 | poco.cn | 舊版, 相容性不確定",srcPattern:"http?://img[d].*pocoimg*",replace:e=>e.replace(/_\d{3}.jpg$/,".jpg")},{site:"颇可网 | poco.cn | 新版",srcPattern:"https://(.*).pocoimg.cn/(.*)",replace:e=>e.replace(/_H\d+./,".")},{site:"蘑菇街",srcPattern:"https?://.*[.]mogucdn[.]com/.*.jpg",replace:e=>e.replace(/_[\d]{3}x[\d]+.jpg$/,"_468x468.jpg").split(".jpg")[0]+".jpg"},{site:"Pinterest",srcPattern:"https://(.*).pinimg.com/(.*).(jpg|png|webp)",replaceAsync:async e=>{if(!e.includes("75x75_RS")&&/\.(jpg|png|webp)/.test(e))try{const a=e.replace(/[0-9]+x/g,"originals").replace("/enabled/","/").replace("/enabled_lo/","/").replace("/enabled_hi/","/").replace("/control/","/"),s=e.match(/\.(jpg|png|webp)/)[0];var r=[".jpg",".png",".webp",".gif"].map(e=>a.replace(s,e));const l=new AbortController,c=setTimeout(()=>l.abort(),3e3),i={method:"HEAD",signal:l.signal};var t=(await Promise.all(r.map(async e=>{e=await fetch(e,i);if(e.ok)return clearTimeout(c),e.url}))).find(e=>"string"==typeof e);if(t)return t;clearTimeout(c)}catch(e){}return e}},{site:"pixiv",srcPattern:/(.*)\/\/i\.pximg\.net\/(.*)/,ignoreCheck:!0,replaceAsync:async i=>new Promise(async r=>{try{const s=new AbortController;var e=i.replace(/c\/\d+x\d+_\d+(_[A-z0-9]{2}){0,1}\//,"").replace(/img-master/,"img-original").replace(/custom-thumb/,"img-original").replace(/_(master|square|custom)1200/,"");if(!e.includes(".jpg")&&!e.includes(".png"))return r(e);const l=e.replace(".jpg",".png"),c=e.replace(".png",".jpg");var t=this.#isValidImageURL(l,s).then(e=>({group:"test1",result:e})),a=this.#isValidImageURL(c,s).then(e=>({group:"test2",result:e}));Promise.race([t,a]).then(e=>{if(s.abort("cancelled reason"),!1===e.result){if("test1"===e.group)return r(c);if("test2"===e.group)return r(l)}return r(e.result)})}catch(e){}})},{site:"1688",srcPattern:"https?://cbu01.alicdn.com/img/ibank/.*..*x.*.jpg",replace:e=>e.replace(/\.\d+x.*\./,".")},{site:"淘宝",srcPattern:/.(?:taobao|tb|ali)cdn(.+)_\d+x\d+.jpg(.*)/,replace:e=>e.replace(/_\d+x\d+.jpg(_.webp)?/,"")},{site:"天猫",srcPattern:/.(?:taobao|tb|ali)cdn(.+)_\d+x\d+\S\d+.jpg(.*)/,replace:e=>e.replace(/_\d+x\d+\S\d+.jpg(_.webp)?/,"")},{site:"Amazon",srcPattern:"https://(images-na.ssl-images|images-fe.ssl-images|m.media)-amazon.com/images/(.*)",replace:e=>e.replace(/\.\_\S+\./,".")},{site:"京东",srcPattern:"https://.*.360buyimg.com.*",replace:e=>e.replace(/\/n\d+\//,"/n0/").replace(/s\d+x\d+_?/,"").split("!cc")[0].split("!q")[0].replace(/.jpg.avif/,".jpg")},{site:"Houzz",srcPattern:"https://st.hzcdn.com/fimgs/*",replace:e=>e.replace(/_/,"_14-").replace("fimgs","simgs").replace(/-w\d+-h\d+-b0-p0/,"")},{site:"HouseBeautiful",srcPattern:"https://hips[.]hearstapps[.]com/.*",replace:e=>e.replace(/[.]jpg{1,}/,".jpg").split("&resize=")[0]},{site:"Officesnapshots",srcPattern:"https://officesnapshots[.]com/.*",replace:e=>e.replace(/-\d{3,4}x\d{3,4}/,"")},{site:"Archilovers",srcPattern:"https://cdn.archilovers.com/.*",replace:e=>e.replace(/(\S_\d+_|thumb\d_)/,"")},{site:"AD",srcPattern:"https://media[.]architecturaldigest[.]com/.*",replace:e=>e.replace(/w_\d+/,"w_5000").replace(/,h_\d+/,"")},{site:"Archdaily 中文版",srcPattern:"https?://images[.]adsttc[.]com[.]qtlcn[.]com/.*",replace:e=>e.replace(/thumb_jpg/,"large_jpg").replace("/medium_jpg/","/large_jpg/").replace("/newsletter/","/large_jpg/")},{site:"ArchDaily 国际版",srcPattern:"https?://images[.]adsttc[.]com/.*",replace:e=>e.replace(/slideshow/,"large_jpg").replace(/thumb_jpg/,"large_jpg").replace("/medium_jpg/","/large_jpg/").replace("/newsletter/","/large_jpg/")},{site:"Dezeen",srcPattern:"https://static[.]dezeen[.]com/.*",replace:e=>e.replace(/slideshow/,"large_jpg").replace(/thumb_jpg/,"large_jpg").replace(/-\d+x\d+.jpg/,".jpg")},{site:"Archiproducts",srcPattern:"https://img[.]edilportale[.]com/.*",replace:e=>e.replace(/-thumbs.*.[a-z]_/,"s/").replace(/news.*.[a-z]_/,"news/")},{site:"officesnapshots wordpress",srcPattern:"https://officesnapshots.com/wp-content/uploads/(.*)",replace:e=>e.replace(/-\d+x\d+-(.*)\./,".").split("?w=")[0]},{site:"wordpress 通用 2.0 (asnyc)",srcPattern:"/wp-content/uploads/.*",replaceAsync:async c=>new Promise(r=>{var t=c.replace(/-\d+x\d+/,"").split("?w=")[0],e=t.match(/\.[a-z]{3,4}\.[a-z]{3,4}$/);const a=new AbortController;setTimeout(()=>a.abort(),3e3);var s=[],l=fetch(t,{method:"HEAD",signal:a.signal});if(s.push(l),e){let e=t.split(".");e.pop(),e=e.join(".");l=fetch(e,{method:"HEAD",signal:a.signal});s.push(l)}Promise.all(s).then(e=>e[1]&&200===e[1].status?r(e[1].url):200===e[0].status?r(e[0].url):r(c)).catch(()=>r(c))})},{site:"Squarespace 通用",srcPattern:"https://static[0-9][.]squarespace[.]com/.*",replace:e=>e.replace(/format=[0-9]{3,4}w/,"format=3000w")},{site:"bilibili专栏",srcPattern:"https://(.*).hdslb.com/(.*)@(.*).(webp|avif)",replace:e=>e.split("@")[0]},{site:"AliyunOSS 通用",srcPattern:/\?x-oss-process=\S+/,replace:e=>{var r="x-oss-process";return(e=new URL(e)).searchParams.delete(r),e.toString()}},{site:"小红书",srcPattern:"https?://sns-webpic-qc.xhscdn.com/(.*)",replace:e=>e.replace(/:\/\/[^/]+(\.xhscdn.com\/+)[0-9]+\/+[0-9a-f]{10,}\/+([^/.?#!]+)(?:[?#!].*)?/,"://sns-img-al$1$2").split("!")[0]},{site:"Medium",srcPattern:"https://cdn-images-[0-9][.]medium[.]com/.*",replace:e=>e.replace(/\/max\/\d{2,4}/,"")},{site:"Medium | 新版",srcPattern:"https://miro.medium.com/v2/(.*)",replace:e=>e.replace(/\/[^/]*:[^/]*\//g,"/")},{site:"Artstation",srcPattern:"https://cdn(.*).artstation.com/(.*)",ignoreCheck:!0,replaceAsync:async c=>new Promise(async r=>{try{const a=new AbortController,s=c.replace(/\d{14}\//,"").replace(/large/,"large").replace(/micro_square/,"large").replace(/smaller_square/,"large").replace(/small_square/,"large"),l=s.replace(/large/,"4k");var e=this.#isValidImageURL(l,a).then(e=>({src:l,valid:e})),t=this.#isValidImageURL(s,a).then(e=>({src:s,valid:e}));Promise.all([e,t]).then(e=>{a.abort();e=e.filter(e=>e.valid);0<e.length&&r(e[0].src)})}catch(e){r(c)}})},{site:"GameUI",srcPattern:"https://image.gameuiux.cn.*",replace:e=>e.replace(/_list/,"_detail")},{site:"GameUI2",srcPattern:"https://img.gameui.net/*",replace:e=>e.match(/(-1@\d+x\d+)/)?e.replace(/(-1@\d+x\d+)\.webp/g,".webp"):e.match(/(@\d+x\d+)\.webp/)?e.replace(/(@\d+x\d+)\.webp/g,".webp"):e},{site:"interiordesign",srcPattern:"https://d4qwptktddc5f[.]cloudfront[.]net/.*",replace:e=>e.replace(/easy_thumbnails\/thumbs_/,"").replace(/[.]jpg.*/,".jpg")},{site:"meiye",srcPattern:"(.*)image.meiye.art/(.*)",replace:e=>e.split("?imageMogr2")[0].split("?vframe")[0]},{site:"即刻",srcPattern:"https://cdn(.*)[.]ruguoapp[.]com/.*",replace:e=>e.split("?imageMogr2")[0]},{site:"腾讯云 通用",srcPattern:"https://(.*)?imageMogr2(.*)",replace:e=>(e.includes("sign-algorithm=")||e.includes("?imageMogr2")&&(e=e.split("?imageMogr2")[0]),e)},{site:"腾讯云 通用 #2",srcPattern:"https://(.*)?imageView2(.*)",replace:e=>(e.includes("q-sign-algorithm=")||e.includes("?imageView2")&&(e=e.split("?imageView2")[0]),e)}];get isRunningInEagleApp(){return"undefined"!=typeof electron}get isEagleHasAbilityToEnlarge(){return!(this.isRunningInEagleApp||!eagle.env?.isAppSupportURLEnlarger)}async enlarge(r,t=3e3){var e;return this.isEagleHasAbilityToEnlarge?{url:r,largeUrl:null}:(e=new Promise(e=>setTimeout(()=>(this.log("URLEnlarger.enlarge timeout, url: "+r),e({url:r,largeUrl:null})),t)),Promise.race([this.#convertURL(r),e]))}async enlargeWithoutCheckEagleHasAbility(r){var e=new Promise(e=>setTimeout(()=>(this.log("URLEnlarger.enlarge timeout, url: "+r),e({url:r,largeUrl:null})),3e3));return Promise.race([this.#convertURL(r),e])}async enlargeBatch(e,t=3e3){if(this.isEagleHasAbilityToEnlarge)return e.map(e=>({url:e,largeUrl:null}));var a=[];for(let r of e){var s=new Promise(e=>setTimeout(()=>e({url:r,largeUrl:null}),t)),s=Promise.race([this.#convertURL(r),s]);a.push(s)}return Promise.all(a)}isEnlargable(r){return!!r&&!r.includes("data:image")&&!r.includes("blob:")&&this.rules.find(e=>{try{if(RegExp(e?.srcPattern).test(r))return!0}catch(e){return!1}})}async#convertURL(a){return new Promise(async e=>{var r,t;return a?-1<a.indexOf("data:image")||!a.startsWith("http://")&&!a.startsWith("https://")||!(r=this.isEnlargable(a))||(t=await this.#ruleReplace(r,a))===a?e({url:a,largeUrl:null}):r.ignoreCheck||this.isRunningInEagleApp||this.#ruleValidMap[r.site]?e({url:a,largeUrl:t}):await this.#isURLExists(t)?(this.#ruleValidMap[r.site]=!0,e({url:a,largeUrl:t})):(this.log("electron-info",`[bg] Large url: ${t} not exists, so use original url: `+a),delete this.#ruleValidMap[r.name],e({url:a,largeUrl:null})):e(a,null)})}async#ruleReplace(e,t){return new Promise(r=>e.replace?r(e.replace(t)):e.replaceAsync?void e.replaceAsync(t).then(e=>r(e)):r(t))}async#isURLExists(e){return new Promise(r=>{eagle.urlTest(e,{}).then(e=>{r(!0===e.responseStatus)})})}async#isValidImageURL(e,r=null){return this.isRunningInEagleApp?this.#checkURLByEagle(e):this.#checkURLByImageElement(e,r)}async#checkURLByEagle(t){return new Promise(r=>{(t.startsWith("https")?require("https"):require("http")).get(t,{method:"HEAD",timeout:3e3,headers:{Referer:t}},e=>400<=e.statusCode?r(!1):r(t))})}async#checkURLByImageElement(t,a){return new Promise(e=>{let r=new Image;r.src=t,r.onload=()=>{e(t)},r.onerror=()=>{r.onload=null,r.onerror=null,r.src="",e(!1)},a&&a.signal.addEventListener("abort",({})=>{r.onload=null,r.onerror=null,r.src=""})})}async#isValidImageURLRejectable(a){return new Promise((e,r)=>{let t=new Image;t.src=a,t.onload=()=>{e(a)},t.onerror=()=>{t.onload=null,t.onerror=null,t.src="",r()}})}log(e){try{ipcRenderer&&ipcRenderer.send("electron-info","[bg] "+e)}catch(e){}}},eagle.urlEnlarger=new globalThis.URLEnlarger;