class BatchSaverIframe{constructor(){this.isReady=!1,this.initializeElements(),this.setupReadyListener()}initializeElements(){var e=eagle.extension.path+"batch-saver-window/index.html",e=jQuery(`<iframe id="eagle-extension-batch-save-window" src="${e}"></iframe>`),t=jQuery('<dialog id="eagle-extension-batch-save-dialog" eagle-extension></dialog>').append(e).appendTo("body");this.dialog=t[0],this.iframe=e[0],document.body.classList.add("eagle-show-batch-save-window"),this.dialog.showModal()}setupReadyListener(){const t=e=>{e.source===this.iframe.contentWindow&&"batchSaver.iframeReady"===e.data.channel&&(this.isReady=!0,window.removeEventListener("message",t))};window.addEventListener("message",t)}sendMessage(e){this.iframe.contentWindow.postMessage(e,"*")}async loaded(){if(!this.isReady)return new Promise(e=>{const t=()=>{this.isReady?e():setTimeout(t,100)};t()})}remove(){this.dialog.close(),document.body.removeChild(this.dialog),document.body.classList.remove("eagle-show-batch-save-window")}}class BatchSaverWindow{detectedUrlMap={};batchSaverIframe;listener;messageListenerMap={};onBatchSave;onCancel;constructor(){this.detectedUrlMap={},this.batchSaverIframe=null,this.#initMessageListener()}async open(e){this.batchSaverIframe||(this.detectedUrlMap={},eagle.env.isAppSupportDownloadViaBrowser?(this.onBatchSave=e.onBatchSave??(()=>{}),this.onCancel=e.onCancel??(()=>{}),await this.#createIframe(e),await this.#sendCollectableItems()):(e=await this.#getCollectableItems(),eagle.item.batchSave(e)))}show(){this.batchSaverIframe&&(document.body.classList.add("eagle-show-batch-save-window"),this.batchSaverIframe.dialog.showModal(),this.batchSaverIframe.iframe.style.display="block")}hide(){this.batchSaverIframe&&(this.batchSaverIframe.dialog.close(),document.body.classList.remove("eagle-show-batch-save-window"),this.batchSaverIframe.iframe.blur(),this.batchSaverIframe.iframe.style.display="none")}close(){this.batchSaverIframe&&this.batchSaverIframe.remove(),this.batchSaverIframe=null,this.listener&&window.removeEventListener("message",this.listener)}async#createIframe(e){this.batchSaverIframe=new BatchSaverIframe(e),await this.batchSaverIframe.loaded(),this.batchSaverIframe.iframe.contentWindow.focus()}#onMessage(e,t){this.messageListenerMap[e]||(this.messageListenerMap[e]=[]),this.messageListenerMap[e].push(t)}#initMessageListener(){this.listener=window.addEventListener("message",t=>{var e;this.batchSaverIframe&&!1!==t.isTrusted&&t.source===this.batchSaverIframe.iframe.contentWindow&&t.data.channel&&(e=t.data.channel,this.messageListenerMap[e])&&this.messageListenerMap[e].forEach(e=>{e(t)})}),this.#onMessage("batchSaver.startDetectMode",async e=>{this.hide(),await this.startAutoDetect(e?.data?.originalSrcs??[]),this.batchSaverIframe?.sendMessage({channel:"batchSaver.stopDetectMode"}),this.show()}),this.#onMessage("batchSaver.downloadItems",e=>{this.close(),this.onBatchSave(e.data??{})}),this.#onMessage("batchSaver.closeWindow",()=>{this.close(),this.onCancel()}),this.#onMessage("batchSaver.createFolder",async e=>{var t=e.data.folderName,e=e.data.parent,t=await eagle.dialog.showCreateFolderDialog(t.trim());t&&this.batchSaverIframe.sendMessage({channel:"batchSaver.createFolderResponse",folderName:t,parent:e})}),this.#onMessage("batchSaver.convertUrlToBase64",async e=>{const{src:a,thumbnail:s}=e.data;a.startsWith("data:image")?this.#updateBatchSaverItem({src:a,base64:a}):(e=await new Promise(t=>{eagle.downloader.download({url:a,thumbnailURL:s||a,silence:!0,onStarted:()=>{},onProgress:e=>{},onComplete:async e=>{e=e.base64;t(e)}})}))?this.#updateBatchSaverItem({src:a,base64:e}):this.#removeBatchSaverItem(a)}),this.#onMessage("batchSaver.enlargeUrl",async e=>{var{url:e,uuid:t}=e.data,a=(await eagle.urlEnlarger.enlargeWithoutCheckEagleHasAbility(e))["largeUrl"];this.batchSaverIframe.sendMessage({channel:"batchSaver.enlargeUrlResponse",uuid:t,url:e,largeUrl:a})})}#formatCollectableItems(e){return e.reduce((e,t)=>{var a,s,r,n,i=t.elementMeta;let l=!1;return"svg"===t.type&&(t.type="image",i.src=t.src),"bg-image"===t.type&&(t.type="image",l=!0),t?.element?({x:a,y:s,width:r,height:n}=t.element.getBoundingClientRect(),t.x=a,t.y=s,t.width=parseInt(r),t.height=parseInt(n),delete t.element,i.src&&!this.detectedUrlMap[i.src]&&(this.detectedUrlMap[i.src]=!0,e.push({type:t.type,width:t.width,height:t.height,title:i.title,src:i.src,thumbnailURL:i.thumbnailURL,url:i.url,urlConverted:l,x:t.x,y:t.y}))):t?.width&&t?.height&&t?.elementMeta?.src&&e.push({type:t.type,width:t.width,height:t.height,title:t.elementMeta.title,src:t.elementMeta.src,url:t.elementMeta.url}),e},[])}async startAutoDetect(r){const n=[];return new Promise(e=>{document.body.classList.remove("eagle-show-batch-save-window"),document.body.focus();let t;function a(){document.body.classList.add("eagle-show-batch-save-window"),jQuery(".eagle-batch-saver-progress-bar").remove(),clearInterval(t),e()}var s;Mousetrap.bind(["esc","d"],e=>{e.preventDefault(),e.stopPropagation(),Mousetrap.unbind(["esc","d"]),a()}),jQuery("#eagle-batch-saver-progress-bar").remove(),(s=jQuery(`
				<div id="eagle-batch-saver-progress-bar" class="eagle-batch-saver-progress-bar" eagle-extension eagle-extension-theme="${eagle.preference.displayTheme}" translate="no">
					<div class="eagle-batch-saver-progress-bar-icon">
						<svg class="spinner" width="16px" height="16px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
							<circle class="path" fill="none" stroke-width="3" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
						</svg>
					</div>
					<div class="eagle-batch-saver-progress-bar-message">${eagle.i18n.words["batch-saver.progress.detecting"]} <span></span></div>
					<div class="eagle-batch-saver-progress-bar-stop-button">${eagle.i18n.words["batch-saver.progress.stop"]}</div>
				</div>
			`)).find(".eagle-batch-saver-progress-bar-stop-button").on("click",()=>{a()}),jQuery("body").append(s),jQuery(".eagle-batch-saver-progress-bar-stop-button").focus(),clearInterval(t),t=setInterval(async()=>{var e;jQuery(".eagle-batch-saver-progress-bar-stop-button").focus(),(await this.#findNewCollectableItems(r)).forEach(t=>{n.find(e=>e.src===t.src)||n.push(t)}),0===(e=n.length)?jQuery(".eagle-batch-saver-progress-bar-message").text(eagle.i18n.words["batch-saver.progress.not-found"]):0<e&&jQuery(".eagle-batch-saver-progress-bar-message").text(eagle.i18n.words["batch-saver.progress.found"].replace("{count}",e))},500)})}async#getCollectableItems(){var e=eagle.elementCollector.getCollectableItems().then(e=>{e=this.#formatCollectableItems(e);return e&&e.length?e:[]}),t=eagle.elementCollector.getIframeCollectableItems().then(e=>{e=this.#formatCollectableItems(e);return e&&e.length?e:[]}),a=eagle.elementCollector.getShadowRootCollectableItems().then(e=>{e=this.#formatCollectableItems(e);return e&&e.length?e:[]}),[e,t,a]=await Promise.all([e,t,a]);return[...e,...t,...a]}async#sendCollectableItems(){let t=0;var e=eagle.elementCollector.getCollectableItems().then(e=>{e=this.#formatCollectableItems(e);e&&e.length&&(this.#sendItems(e),t+=e.length)}),a=eagle.elementCollector.getIframeCollectableItems().then(e=>{e=this.#formatCollectableItems(e);e&&e.length&&(this.#sendItems(e),t+=e.length)}),s=eagle.elementCollector.getShadowRootCollectableItems().then(e=>{e=this.#formatCollectableItems(e);e&&e.length&&(this.#sendItems(e),t+=e.length)});return await Promise.all([e,a,s]),t}async#findNewCollectableItems(t){let e=await eagle.elementCollector.getCollectableItems();e=e.filter(e=>!t.includes(e.elementMeta.src));var a=this.#formatCollectableItems(e);return this.#sendItems(a),a}#sendItems(e){this.batchSaverIframe.sendMessage({channel:"batchSaver.sendItems",items:e})}#updateBatchSaverItem({src:e,base64:t}){this.batchSaverIframe.sendMessage({channel:"batchSaver.updateBatchSaverItem",src:e,base64:t})}#removeBatchSaverItem(e){this.batchSaverIframe.sendMessage({channel:"batchSaver.removeBatchSaverItem",src:e})}}class BatchSaver{batchSaverWindow=null;constructor(){this.batchSaverWindow=new BatchSaverWindow,this.#initShortcut(),this.#registerRuntimeChannel(),eagle.shortcuts.changed(()=>{this.#initShortcut()})}async open(){await this.batchSaverWindow.open({onBatchSave:this.#onBatchSave.bind(this)})}async#onBatchSave(a){a.images.map(e=>{let t={type:"image",src:e.src,title:e.title||document.title||"untitled",url:e.url||location.href,thumbnailURL:e.thumbnail||e.src,elementType:e.type,tags:[]};return e.duration&&(t.duration=e.duration),e.annotation&&(t.annotation=e.annotation),e.modificationTime&&(t.modificationTime=e.modificationTime),a.tags&&(t.tags=a.tags),a.folders&&(t.folderIDs=a.folders.map(e=>e.id),a.folders.forEach(e=>{e.extendTags&&e.extendTags.length&&Array.prototype.push.apply(t.tags,e.extendTags)})),t.tags=[...new Set(t.tags)],t}).forEach(e=>{eagle.item.addBatchSaveFile(e)})}#initShortcut(){var e;eagle.preference.keybindings["batch-save"]&&(e=eagle.preference.keybindings["batch-save"].replace(/\s/g,"").toLowerCase(),Mousetrap.bind(e,eagle.utils.debounce(async e=>{if(await eagle.env.isReady())return e.preventDefault(),this.open(),!1},500,!0)))}#registerRuntimeChannel(){eagle.runtime.onMessage("batch-save",async(e,t,a)=>{if(await eagle.env.isReady())return this.open(),a(),!0})}}eagle.preference.ready(()=>{eagle.batchSaver=new BatchSaver});