class Cropper{#$cropperArea;#MAX_PRIMARY_DIMENSION=eagle.env.canvas.maxSide;#playingVideos=[];constructor({onClose:e,onCropped:t}){this.onCropped=t||(()=>{}),this.onClose=e||(()=>{}),this.#registerShortcuts(),this.#createCropper()}#isElementNotInsideCropperArea(e){return!($.contains(this.#$cropperArea[0],e)||this.#$cropperArea[0]===e)}#registerShortcuts(){let t=this;Mousetrap.bind(["enter"],eagle.utils.debounce(e=>(0<$("#eagle-crop-save-button").length&&$("#eagle-crop-save-button").trigger("click"),!1),500,!0)),Mousetrap.bind(["up"],e=>(e.preventDefault(),t.moveCropper(0,-1),!1)),Mousetrap.bind(["down"],e=>(e.preventDefault(),t.moveCropper(0,1),!1)),Mousetrap.bind(["left"],e=>(e.preventDefault(),t.moveCropper(-1,0),!1)),Mousetrap.bind(["right"],e=>(e.preventDefault(),t.moveCropper(1,0),!1)),Mousetrap.bind(["shift+up"],e=>(e.preventDefault(),t.moveCropper(0,-10),!1)),Mousetrap.bind(["shift+down"],e=>(e.preventDefault(),t.moveCropper(0,10),!1)),Mousetrap.bind(["shift+left"],e=>(e.preventDefault(),t.moveCropper(-10,0),!1)),Mousetrap.bind(["shift+right"],e=>(e.preventDefault(),t.moveCropper(10,0),!1)),Mousetrap.bind(["mod+up"],e=>(e.preventDefault(),t.resizeCropper(0,-1),!1)),Mousetrap.bind(["mod+down"],e=>(e.preventDefault(),t.resizeCropper(0,1),!1)),Mousetrap.bind(["mod+left"],e=>(e.preventDefault(),t.resizeCropper(-1,0),!1)),Mousetrap.bind(["mod+right"],e=>(e.preventDefault(),t.resizeCropper(1,0),!1)),Mousetrap.bind(["mod+shift+up"],e=>(e.preventDefault(),t.resizeCropper(0,-10),!1)),Mousetrap.bind(["mod+shift+down"],e=>(e.preventDefault(),t.resizeCropper(0,10),!1)),Mousetrap.bind(["mod+shift+left"],e=>(e.preventDefault(),t.resizeCropper(-10,0),!1)),Mousetrap.bind(["mod+shift+right"],e=>(e.preventDefault(),t.resizeCropper(10,0),!1)),Mousetrap.bind(["mod+a"],e=>(e.preventDefault(),t.maxCropper(),!1)),Mousetrap.bind(["esc"],eagle.utils.debounce(e=>(t.destroyCropArea(),!1),500,!0))}#createCropper(){if(!this.#hasCropper()){const z=this;document.documentElement.classList.remove("hide-eagle-cropper"),this.#$cropperArea=$(`
			<div id="eagle-resize-tool" class="eagle-resizable" eagle-scrolling-hidden eagle-extension translate="no">
				<div id="eagle-crop-size" class="eagle-crop-size"></div>
				<div class="resizers">
					<div class='eagle-overlay t'></div>
					<div class='eagle-overlay r'></div>
					<div class='eagle-overlay b'></div>
					<div class='eagle-overlay l'></div>
					<div class="crop-buttons">
						<div id="eagle-crop-save-button" class="crop-button">${eagle.i18n.words["cropper.save"]}</div>
						<div id="eagle-crop-close-button" class="crop-button">${eagle.i18n.words["cropper.cancel"]}</div>
					</div>
				</div>
				<div class="scroll-helper top"></div>
				<div class="scroll-helper bottom"></div>
				<div class="eagle-crosshair-v"></div>
				<div class="eagle-crosshair-h"></div>
				<div id="eagle-cropper-inspector"></div>
				<div class="eagle-resizable-overlay"></div>
			</div>
		`),$("html").addClass("eagle-cropper-opened");let s=function(){var e=[window?.outerHeight,document?.documentElement?.clientHeight,document?.documentElement?.offsetHeight,document?.documentElement?.scrollHeight,document?.body?.scrollHeight,document?.body?.offsetHeight];z.#$cropperArea.height(Math.max(...e))},i=eagle.utils.throttle(()=>{var e,t,o,r,s=z.#$cropperArea.find(".resizers");0!==s.length&&(t=(e=$(window).scrollTop())+window.innerHeight,o=s.position().top+s.height(),r=z.#$cropperArea.find(".crop-buttons"),0<s.height()?t<o+40?(r.css({left:s.offset().left+s.width()-r.width()-5+"px"}),r.removeClass("overlap-top").addClass("overlap-bottom")):o<e?(r.css({left:s.offset().left+s.width()-r.width()-5+"px"}),r.removeClass("overlap-bottom").addClass("overlap-top")):(r.css({left:""}),r.removeClass("overlap-top overlap-bottom")):(r.removeClass("overlap-top overlap-bottom"),r.css({left:""})))},50),a=($("body").off("update-crop-position").on("update-crop-position",()=>{i()}),s(),i(),$(window).on("resize.crop",eagle.utils.throttle(()=>{z.#$cropperArea.height(document.scrollingElement.scrollHeight)},250)),$("body").append(z.#$cropperArea),z.#$cropperArea.find(".resizers")),l=$("#eagle-crop-size");var e=z.#$cropperArea.find(".eagle-resizable-overlay"),t=$("#eagle-crop-save-button"),o=$("#eagle-crop-close-button");let n=z.#$cropperArea.find(".crop-buttons"),p=z.#$cropperArea.find(".eagle-crosshair-v"),d=z.#$cropperArea.find(".eagle-crosshair-h");t.on("click",e=>{e.stopPropagation();var e=document.querySelector("#eagle-resize-tool .resizers"),e=$(e),t=e.outerHeight(),o=e.outerWidth(),e=e.offset(),e={x:parseInt(e.left)||0,y:parseInt(e.top)||0,width:parseInt(o)||0,height:parseInt(t)||0};this.onCropped(e),this.destroyCropArea()}),o.on("click",e=>{e.stopPropagation(),this.onClose(),z.destroyCropArea()}),a.draggable({scroll:!0,containment:"document"}),a.resizable({handles:"n, e, s, w, ne, se, sw, nw",maxHeight:this.#MAX_PRIMARY_DIMENSION-4096,maxWidth:this.#MAX_PRIMARY_DIMENSION-4096,containment:"document"});var r,h,c,u,f=$(".scroll-helper"),g=20,v=$(document),m=(a.on("resizestart",()=>{f.off("mouseenter").off("mouseleave").on("mouseenter",w).on("mouseleave",C)}),a.on("resizestop",(e,t)=>{f.off("mouseenter").off("mouseleave"),clearInterval(r)}),a.find(".ui-resizable-handle").hide(),!1),b={x:0,y:0},t=(e.on("mousedown",e=>{e.stopPropagation(),a.addClass("pointer-ignore"),n.hide(),m=!0,b={x:e.offsetX,y:e.offsetY}}),$(window).off("scroll.cropping").on("scroll.cropping",eagle.utils.throttle(()=>{i()},50,!0)),e.on("mousemove",t=>{var e,o,r,s;!t.metaKey&&!t.ctrlKey||t.shiftKey?(c=void 0,z.highlightElem(void 0)):(clearTimeout(h),h=setTimeout(()=>{var e={x:t.clientX,y:t.clientY};c=eagle.elementInspector.getFilteredElementByPoint(e,e=>this.#isElementNotInsideCropperArea(e)),z.highlightElem(c)},20)),m?(e=b.x-t.offsetX,o=b.y-t.offsetY,5<Math.abs(e)&&5<Math.abs(o)&&(s=0<e?b.x-e:b.x,r=0<o?b.y-o:b.y,e=Math.min(Math.abs(e),z.#MAX_PRIMARY_DIMENSION-4096),o=Math.min(Math.abs(o),z.#MAX_PRIMARY_DIMENSION-4096),t.shiftKey&&(e=o),a.css({left:s+"px",top:r+"px",width:e,height:o}),a.find(".ui-resizable-handle").show(),l.show(),l.addClass("orientation-se"),l.css({top:t.pageY+"px",left:t.pageX+"px"}),l.html(Math.abs(parseInt(e))+"×"+Math.abs(parseInt(o))))):this.#hasCropperVisible()||(l.show(),l.addClass("orientation-se"),l.css({top:t.pageY+"px",left:t.pageX+"px"}),s=eagle.i18n.words["cropper.tips"],eagle.env.os.isMac&&(s=s.replace("Ctrl","⌘")),l.html(s)),p.css({left:t.clientX}),d.css({top:t.clientY})}),e.on("contextmenu",e=>{e.stopPropagation(),e.preventDefault(),z.destroyCropArea()}),e.on("mouseup",e=>{var t,o,r,e={x:e.clientX,y:e.clientY},e=(m=!1,a.removeClass("pointer-ignore"),l.hide(),n.show(),l.html(""),eagle.elementInspector.getFilteredElementByPoint(e,e=>this.#isElementNotInsideCropperArea(e)));e&&e===c?(t=(e=$(e)).offset(),o=e.outerWidth(),e=e.outerHeight(),r=this.#$cropperArea.offset().top,a.css({top:t.top-r+"px",left:t.left+"px",width:Math.min(o,window.innerWidth),height:e}),a.find(".ui-resizable-handle").show(),i(),c=void 0,z.highlightElem(void 0)):(s(),i())}),a.on("mousemove",(e,t)=>{!e.metaKey&&!e.ctrlKey||e.shiftKey?(c=void 0,z.highlightElem(void 0),p.css({left:e.clientX}),d.css({top:e.clientY})):(clearTimeout(h),h=setTimeout(()=>{c=eagle.elementInspector.getFilteredElementByPoint({x:e.pageX,y:e.pageY},e=>this.#isElementNotInsideCropperArea(e)),z.highlightElem(c)},20))}),a.on("mouseup",(e,t)=>{var o,r;(e.metaKey||e.ctrlKey)&&(e.preventDefault(),e=eagle.elementInspector.getFilteredElementByPoint({x:e.pageX,y:e.pageY},e=>this.#isElementNotInsideCropperArea(e)))&&e===c&&(o=(e=$(e)).offset(),r=e.outerWidth(),e=e.outerHeight(),a.css({top:o.top+"px",left:o.left+"px",width:Math.min(r,window.innerWidth),height:e}),a.find(".ui-resizable-handle").show(),c=void 0,z.highlightElem(void 0))}),a.on("mouseover",(e,t)=>{clearTimeout(u),u=setTimeout(()=>{p.hide(),d.hide()},300)}),a.on("mouseleave",(e,t)=>{clearTimeout(u),p.show(),d.show()}),a.on("resizestart",(e,t)=>{e.stopPropagation(),l.show();e=e.originalEvent.target.classList.value;l.removeClass("orientation-ne orientation-se orientation-nw orientation-sw orientation-n orientation-e orientation-s orientation-w"),-1<e.indexOf("ui-resizable-ne")?l.addClass("orientation-ne"):-1<e.indexOf("ui-resizable-se")?l.addClass("orientation-se"):-1<e.indexOf("ui-resizable-sw")?l.addClass("orientation-sw"):-1<e.indexOf("ui-resizable-nw")?l.addClass("orientation-nw"):-1<e.indexOf("ui-resizable-w")?l.addClass("orientation-w"):-1<e.indexOf("ui-resizable-e")?l.addClass("orientation-e"):-1<e.indexOf("ui-resizable-s")?l.addClass("orientation-s"):-1<e.indexOf("ui-resizable-n")&&l.addClass("orientation-n"),i()}),a.on("resize",(e,t)=>{var o=a.width(),r=a.height();l.css({top:e.pageY+"px",left:e.pageX+"px"}),l.html(parseInt(o)+"×"+parseInt(r)),i()}),a.on("resizestop",(e,t)=>{e.stopPropagation(),l.hide(),s(),i()}),a.on("drag",(e,t)=>{i()}),a.on("dragstop",(e,t)=>{s(),i()}),this.#pauseVideo());function C(){g=20,clearInterval(r)}function w(){let e=g;$(this).hasClass("top")&&(e=-g),r=setInterval(()=>{v.scrollTop(v.scrollTop()+e),60<(g+=.8)&&(g=60)},20)}this.#playingVideos=new Set([...this.#playingVideos,...t])}}destroyCropArea(){var e,t,o,r=$("#eagle-resize-tool");0!==r.length&&($(window).off("resize.crop"),$("html").removeClass("eagle-cropper-opened"),e=r.find(".resizers"),$("#eagle-crop-size"),t=r.find(".eagle-resizable-overlay"),o=$("#eagle-crop-close-button"),t.off("mousedown"),t.off("mousemove"),t.off("mouseup"),e.off("resizestart"),e.off("resize"),e.off("mousemove"),e.off("mouseover"),e.off("mouseleave"),e.off("resizestop"),o.off("click"),r.remove(),this.#playingVideos.forEach(e=>{e.play()}),this.#playingVideos=[])}#hasCropper(){var e=document.querySelector("#eagle-resize-tool");return!!e&&!!e.querySelector(".resizers")}#hasCropperVisible(){var e=document.querySelector("#eagle-resize-tool");return!!e&&(e=e.querySelector(".resizers"))&&0<e.clientWidth}maxCropper(){this.#hasCropper()||this.#createCropper();var e=$("#eagle-resize-tool").find(".resizers"),t=document.body,o=document.documentElement,r=Math.max(t.scrollHeight,t.offsetHeight,o.clientHeight,o.scrollHeight,o.offsetHeight),t=Math.max(t.offsetWidth,o.clientWidth,o.scrollWidth,o.offsetWidth);e.find(".ui-resizable-handle").show(),e.css("height",r),e.css("width",t),e.css("left","0px"),e.css("top","0px"),$("body").trigger("update-crop-position")}moveCropper(e,t){var o,r,s,i,a;this.#hasCropper()&&(i=(o=$("#eagle-resize-tool").find(".resizers")).position(),r=o.width(),o.height(),s=i.top,i=i.left,a=window.innerWidth,0!==e&&(0<e&&i+e+r<a||e<0&&0<i+e)&&o.css("left",i+e),0!==t)&&(0<t||t<0&&0<s+t)&&o.css("top",s+t)}resizeCropper(e,t){var o,r,s,i,a,l;this.#hasCropper()&&(a=(o=$("#eagle-resize-tool").find(".resizers")).position(),r=o.outerWidth(),s=o.outerHeight(),i=a.top,a=a.left,l=window.innerWidth,0!==e&&(0<e&&a+e+r<l||e<0&&0<a+e)&&o.css("width",r+e),0!==t)&&(0<t||t<0&&0<i+t)&&o.css("height",s+t)}highlightElem(e){var t,o,r;e?(t=(e=$(e)).offset(),o=e.outerWidth(),e=e.outerHeight(),r=this.#$cropperArea.offset().top,$("#eagle-cropper-inspector").css({top:parseInt(t.top)-r+"px",left:parseInt(t.left)+"px",width:parseInt(o),height:parseInt(e)}),$("#eagle-cropper-inspector").addClass("show")):($("#eagle-cropper-inspector").css({width:0,height:0}),$("#eagle-cropper-inspector").removeClass("show"))}#pauseVideo(){var e=document.querySelectorAll("video");let t=[];return Array.from(e).filter(e=>!e.paused).forEach(e=>{t.push(e),e.pause()}),t}}