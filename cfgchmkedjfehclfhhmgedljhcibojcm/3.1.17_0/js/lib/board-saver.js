const EAGLE_SERVER_URL="http://localhost:41595",EAGLE_IMPORT_API_URL=EAGLE_SERVER_URL+"/api/item/addFromURLs",EAGLE_CREATE_FOLDER_API_URL=EAGLE_SERVER_URL+"/api/folder/create";class BoardSaver{rules=[];queue;constructor(){this.#registerRuntimeChannel(),this.queue=new eagle.Queue(async({image:e,pageInfo:t},a)=>{var{url:i,largeUrl:r}=eagle.preference.downloadViaBrowser?await eagle.urlEnlarger.enlargeWithoutCheckEagleHasAbility(e.url):await eagle.urlEnlarger.enlarge(e.url),r=(e.url=r||i,i);eagle.item.addBatchSaveFile({folderID:t.folderId,type:"image",version:eagle.extension.manifest.version,src:e.url,thumbnailURL:r,title:e.name,url:e.website,annotation:"",modificationTime:e.modificationTime}),a()},5)}#registerRuntimeChannel(){eagle.runtime.onMessage("save-board",(e,t,a)=>(this.start(),a(),!0))}async start(){var a;function t(){jQuery(".eagle-save-board-progress-bar").remove()}let i=location.href,r,e;if((e=0===this.rules.length?await this.getRules():this.rules).forEach(e=>{-1!==i.indexOf(e.urlPattern)&&(r=e)}),r){var o=Date.now(),s=0,l=100,n=200,c={imageCount:0,imageSet:{},linkSet:{},allImgElems:[],folderId:""},g=location.href;let e=window;r.selector.scrollEle&&(e=document.querySelector(r.selector.scrollEle)||window);var d=function(){e.scrollTo(0,(e.scrollY||e.scrollTop||0)+(e.innerHeight||e.offsetHeight||100)/2),e.scrollY||e.scrollTop},m=async()=>{var e=Array.from(document.querySelectorAll(r.selector.image)),t=(e.forEach(e=>{c.allImgElems.push(e)}),c.allImgElems=[...new Set(c.allImgElems)],[]);for(const i of e=e.filter(e=>{e=e.src;return!c.imageSet[e]&&(c.imageSet[e]=!0)})){c.imageCount++,a=c.imageCount,jQuery(".eagle-save-board-progress-bar-message span").text(`(${a})`);var a=await eagle.elementInspector.getMeta(i),a=new URL(a.src||i.src);a.searchParams.append("v",Date.now()),t.push({name:await(async e=>{var t=eagle.plugin.get(location.href);t?.getMeta&&t.getMeta(e);return(t=t?.getMetaAsync&&await t.getMetaAsync(e))?.title?t?.title:(t=e.closest(r.selector.box),e.alt&&!r.selector.ignoreAlt?e.alt:t&&t.innerText?t.innerText:t&&t.textContent?t.textContent:"")})(i)||document.title,url:decodeURIComponent(a.href),website:function(e){if(r.selector.box)for(var t=Array.from(document.querySelectorAll(r.selector.box)),a=0;a<t.length;a++)if(t[a].contains(e))return eagle.utils.absolutePath(t[a].querySelector(r.selector.link)?.href)||location.href;return""}(i),modificationTime:o-c.imageCount})}return t};const f=()=>{var e=c.allImgElems.length-c.imageCount;0<e?alert(""+eagle.i18n.words["board-saver.finish.msg1"]+eagle.i18n.words["board-saver.finish.msg2"].replace("{count}",e)+eagle.i18n.words["board-saver.finish.msg3"].replace("{count}",c.imageCount)):alert(""+eagle.i18n.words["board-saver.finish.msg1"]+eagle.i18n.words["board-saver.finish.msg3"].replace("{count}",c.imageCount)),clearInterval(a),t()};var h,u=async()=>{var e=await m(),e=(0<e.length?(s=0,p(e)):s++,location.href!=g&&f(),r.selector.endElem&&document.querySelector(r.selector.endElem)),e=(e&&f(),$(r.selector.spinner)?.is(":visible")?n:l),e=(e<=s&&(e=eagle.i18n.words["board-saver.progress.hit-bottom"],jQuery(".eagle-save-board-progress-bar-message").text(e)),d(),r.selector.moreBtn&&document.querySelector(r.selector.moreBtn));e&&e.click()},p=async e=>{if(e&&0!==e.length)for(const t of e)this.queue.push({image:t,pageInfo:c})},v=(e.scrollTo(0,0),e.scrollY||e.scrollTop,(v=jQuery(`
				<div class="eagle-save-board-progress-bar" eagle-extension eagle-extension-theme="${eagle.preference.displayTheme}" translate="no">
					<div class="eagle-save-board-progress-bar-icon">
						<svg class="spinner" width="16px" height="16px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
							<circle class="path" fill="none" stroke-width="3" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
						</svg>
					</div>
					<div class="eagle-save-board-progress-bar-message">${eagle.i18n.words["board-saver.progress.crawling"]} <span></span></div>
					<div class="eagle-save-board-progress-bar-stop-button">${eagle.i18n.words["board-saver.progress.stop"]}</div>
				</div>
			`)).find(".eagle-save-board-progress-bar-stop-button").on("click",()=>{t(),clearInterval(a)}),jQuery("body").append(v),jQuery(r.selector.title).text()||document.querySelector("title").text||document.title);v=v,h=(e,t)=>{t&&(c.folderId=t.id,a=setInterval(u,100))},eagle.fetch(EAGLE_CREATE_FOLDER_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folderName:v})}).then(e=>{try{"success"===e.status&&e.data&&e.data.id?h(void 0,e.data):h(!0)}catch(e){h(!0)}})}}async getRules(){return new Promise(async t=>{if(0<this.rules.length)return t(this.rules);const a=[{site:"huaban",urlPattern:"huaban.com/boards",selector:{title:"h1",image:".infinite-scroll-component a[href*='pins'] img",link:".infinite-scroll-component a[href*='pins']",box:"[data-pin-id]",spinner:".loading"}},{site:"pinterest",urlPattern:"pinterest.",selector:{title:"h1",image:"[data-grid-item] a [data-test-id='pinrep-image'] img",link:"[data-grid-item] a",box:"[data-grid-item]",spinner:"[data-test-id='homefeed-feed'] svg path[d]:empty, [data-test-id='board-feed'] svg path[d]:empty",ignoreAlt:!0}},{site:"dribbble",urlPattern:"dribbble.com/",selector:{title:"h1",image:'[data-thumbnail-id] figure img:not([src^="data:image/gif;base64,"])',link:"[data-thumbnail-id] a.shot-thumbnail-link",box:"[data-thumbnail-id]",spinner:".loading-more .processing",moreBtn:".load-more"}},{site:"meiye",urlPattern:"meiye.art/",selector:{scrollEle:".overBoxCon",title:"h1",image:'.app-main .imgBox .wrap img[src*="image.meiye.art"]',box:'.app-main .imgBox .wrap img[src*="image.meiye.art"]',spinner:"#load"}},{site:"xiaohongshu",urlPattern:"xiaohongshu.com/",selector:{image:"section.note-item a.cover img, section.note-item a.cover[style*='background-image']",link:"section.note-item a",box:"section.note-item",spinner:".loading .feeds-loading.active"}},{site:"twitter",urlPattern:"twitter.com/",selector:{image:"section div[data-testid='cellInnerDiv'] article a[href*='photo'] img, section li[role='listitem'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo'] img",link:"section div[data-testid='cellInnerDiv'] article a[href*='photo'], section li[role='listitem'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo']",box:"section div[data-testid='cellInnerDiv'], section li[role='listitem']",spinner:"div[role='progressbar']"}},{site:"x (twitter)",urlPattern:"x.com/",selector:{image:"section div[data-testid='cellInnerDiv'] article a[href*='photo'] img, section li[role='listitem'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo'] img",link:"section div[data-testid='cellInnerDiv'] article a[href*='photo'], section li[role='listitem'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo']",box:"section div[data-testid='cellInnerDiv'], section li[role='listitem']",spinner:"div[role='progressbar']"}},{site:"gameui",urlPattern:"gameui.net/inspiration",selector:{image:"div.imgs-area a img",link:"div.imgs-area a",box:"div.imgs-area",spinner:"div.pro-bot-loading"}}];eagle.fetch("https://oss-app.eagle.cool/extensions/batch-save-image-rules.json").then(e=>e&&e.length?(this.rules=e,t(e)):(this.rules=a,t(a)))})}}eagle.boardSaver=new BoardSaver;