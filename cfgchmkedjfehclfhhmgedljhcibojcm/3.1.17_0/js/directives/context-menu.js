class ContextMenu{static open(e){angular.element("html").scope().$broadcast("CONTEXTMENU.OPEN",e)}static close(){angular.element("html").scope().$broadcast("CONTEXTMENU.CLOSE")}}angular.module("contextMenu",["i18n"]).directive("contextMenuItems",()=>({restrict:"E",templateUrl:"/js/directives/context-menu-items.html",scope:{menu:"=",activeMenu:"=",searchKeyword:"=",theme:"=theme"},replace:!1,link:(e,t,n)=>{e.toggleItem=e.$parent.toggleItem,e.openItem=e.$parent.openItem,e.openMore=e.$parent.openMore,e.hoverItem=e.$parent.hoverItem,e.sortableOptions=e.$parent.sortableOptions}})).directive("contextMenu",["$timeout",g=>({restrict:"E",templateUrl:"/js/directives/context-menu.html",replace:!1,scope:{theme:"=theme"},link:(l,e,t)=>{let n,i,s,r,a="",o=null;l.sortableOptions={distance:10,animation:200,disabled:!1,helper:"clone",update:(e,t)=>{setTimeout(()=>{s&&s(r.items)},1)}};const c=e.find("> .context-menu"),u=e.find("input[type='search']"),d=(u.on("focus",()=>{c.hasClass("open")||f()}),()=>{var e,t;0<l.activeMenu.currentIndex&&(e=l.activeMenu.currentIndex-1,t=l.activeMenu.items[e])&&(l.activeMenu.currentIndex=e,h(t)||d())}),m=()=>{var e,t;l.activeMenu.currentIndex<l.activeMenu.items.length-1&&(e=l.activeMenu.currentIndex+1,t=l.activeMenu.items[e])&&(l.activeMenu.currentIndex=e,h(t)||m())},p=e=>{e?.submenu&&(l.activeMenu=e.submenu,l.activeMenu.currentIndex=0)},h=e=>"toggle"===e.role||!e.role&&!e.disabled;const M=e=>{e&&!e?.submenu&&(e?.click&&e.click(e),e?.keepOpen?void 0!==e.checked&&(e.checked=!e.checked):l.close())};const v=(n,i)=>{var s=$(window).width(),r=$(window).height(),a=c.width(),o=c.height(),u=l.displayMenu.showSearch?36:0;if(i<5&&(o<34+u||a<90))v(n,i+1);else{let e=windowMouseX+10,t=windowMouseY-10;windowMouseX+a>s&&(e=windowMouseX-a-5),windowMouseY+o>r-20?t=(t=r-o-20)<20?20:t:windowMouseY-56<0&&(t=36),c.css({left:e+"px",top:t+"px"});i=r-u-t-20;c.find(".context-menu-items").css({maxHeight:i+"px"}),n()}},b=()=>{c.find(".context-menu-items").css("max-height",""),l.searchKeyword="",l.displayMenu={},l.activeMenu=null,c.removeClass("open"),f(),i()},w=()=>{u.focus()},f=()=>{u.blur()};let x=!1;l.$on("CONTEXTMENU.OPEN",(e,t)=>{(t=t).items=t.items.filter(e=>!1!==e.visible),eagle.utils.tree.walk(t,"items",function(e,t){e.submenu&&(e.submenu.items=e.submenu.items.filter(e=>!1!==e.visible))}),r=t,l.sortableOptions={distance:10,animation:200,handle:t.sortableHelper?".drag-helper":void 0,disabled:!1,helper:"clone",update:(e,t)=>{setTimeout(()=>{s&&s(r.items)},1)}},l.width=t.width||"auto",l.displayMenu=t,l.displayMenu.currentIndex=-1,l.activeMenu=t,n=t.onOpened||(()=>{}),i=t.onClosed||(()=>{}),s=t.onSorted||(()=>{}),g(()=>{v(()=>{c.addClass("open"),n(),setTimeout(w,50)},0)},50)}),l.$on("CONTEXTMENU.CLOSE",e=>{b()}),Object.assign(l,{searchKeyword:"",menu:null,activeMenu:null,focusSearchInput:w,onSearchKeydown:e=>{var t,n=l?.activeMenu?.currentIndex,i=l?.activeMenu?.items?l.activeMenu.items[n]:null;switch(e.keyCode){case 13:e.preventDefault(),x=!0;break;case 38:e.preventDefault(),d();break;case 40:e.preventDefault(),m();break;case 37:l.activeMenu=r;break;case 39:p(i);break;case 27:e.preventDefault();break;default:l.displayMenu.showSearch||(e.stopPropagation(),e.preventDefault(),a+=String.fromCharCode(e.keyCode).toLowerCase(),clearTimeout(o),o=setTimeout(()=>{a=""},500),0<=(t=l.activeMenu.items.findIndex(e=>e?.label?.toLowerCase().startsWith(a)))&&(l.activeMenu.currentIndex=t))}},onSearchKeyup:e=>{var t=l?.activeMenu?.items[l.activeMenu.currentIndex];switch(e.keyCode){case 32:l.displayMenu.showSearch||(e.preventDefault(),M(t));break;case 13:x&&(M(t),x=!1);break;case 27:e.preventDefault(),b()}},onSearchChange:()=>{l.displayMenu.showSearch&&(""!==l.searchKeyword?(l.displayMenu=(()=>{const n=(e,n)=>{if(!e)return;if(!n)return e;let t=e.filter(e=>{const t=`${e.label??""} ${e.keywords??""}`;return t.toLowerCase().indexOf(n.toLowerCase())>=0});t=t.filter(e=>!e.role||e.role==="toggle");t=t.filter(e=>!e.submenu);t=t.filter(e=>!e.disabled);return t};let i={items:[],showSearch:true,currentIndex:0},e=n(r.items,l.searchKeyword);return i.items=[...e],r.items.forEach(t=>{if(t?.submenu?.items){let e=n(t.submenu.items,l.searchKeyword);if(e.length>0){if(i.items.length>0)e=[{role:"separator"},{role:"label",label:t.label},...e];else e=[{role:"label",label:t.label},...e];i.items=[...i.items,...e]}}}),i.currentIndex=i.items.findIndex(e=>h(e))||0,i})(),l.sortableOptions.disabled=!0):(l.displayMenu=r,l.displayMenu.currentIndex=-1,l.sortableOptions.disabled=!1),l.activeMenu=l.displayMenu)},openItem:M,openMore:e=>{e?.more&&e.more(e)},toggleItem:e=>{e.pinned=!e.pinned,e?.toggle&&e.toggle(e.pinned)},hoverItem:(e,t)=>{t.currentIndex=e;t=(l.activeMenu=t).items[e];p(t)},close:b})}})]).directive("autoPositionContextMenu",["$timeout",n=>({restrict:"A",link:(e,d)=>{var t=()=>{var n=$("#submenu-placeholder").parent();if(n.length){var{top:i,left:s}=n.position(),{top:r,left:a}=n.offset(),o=r+d.height(),u=a+n.outerWidth()+d.outerWidth(),l=$(window).height()-20,c=$(window).width()-20;let e=0,t=0;l<o&&(e=o-l),c<u&&(t=n.outerWidth()+d.outerWidth());o=i-(e=Math.min(e,r)),c=Math.max(20-a,s+n.outerWidth()-t-4);d.css({opacity:1,top:o+"px",left:c+"px"}),d.find(".context-menu-items").css({maxHeight:l-e+"px"})}};n(t,50),$(window).off("resize.submenu").on("resize.submenu",t)}})]);