angular.module("vsGridRepeat",[]).directive("vsGridRepeat",["$window","$compile",function(e,t){return{restrict:"A",transclude:!0,scope:{vsGridRepeatOptions:"=",vsGridItems:"=",vsGridState:"="},link:function(s,a,e,t,n){const p=s.$parent;let i=s.vsGridRepeatOptions||{columnWidth:100,columnHeight:100,columnGap:8,rowGap:12,extraRange:200,groupLabelHeight:40,squareMode:!1,listMode:!1,padding:4,paddingTop:4,paddingBottom:4,paddingLeft:4,paddingRight:4},{columnWidth:h,columnHeight:g,columnGap:c,rowGap:m,extraRange:u,groupLabelHeight:v,squareMode:f,listMode:y,padding:d}=(s.vsGridItems||(s.vsGridItems=[]),s.vsGridState||(s.vsGridState={}),i),x=i.paddingTop??i.padding??0,G=i.paddingBottom??i.padding??0,S=i.paddingLeft??i.padding??0,$=i.paddingRight??i.padding??0,w=a[0],R=0,E=0,I=0,M=[],b={},C={},A={};var e=e.vsGridRepeat,o=e.match(/^\s*(\S+)\s+in\s+(\S+)\s*$/);if(!o)throw new Error("Expected vsGridRepeat in form of '_item_ in _collection_' but got '"+e+"'.");e=o[2];function T(e,t,i,d){for(;i<=d;){var o=Math.floor((i+d)/2);e[o].y<t?i=o+1:d=o-1}return i}function r({}={}){if(p.groups){{var i=w.clientWidth-S-$;E=0,R=(R=y?1:Math.floor(i/(h+c)))<1?1:R;const r=1===p.groups.length;p.groups.forEach((e,t)=>{t=0===t?v-x:v;r||(E+=t),e.isCollapsed||(E+=Math.ceil(e.items.length/R)*(g+m))}),E=(E=(E+=x)+G)+x,s.vsGridState&&(s.vsGridState.totalHeight=E,s.vsGridState.columns=R)}{let a=w.clientWidth-S-$,n=(s.vsGridItems=[],C={},A={},x??0);const l=1===p.groups.length;p.groups.forEach((e,t)=>{var i=0===t?v-x:v;if(l||(s.vsGridItems.push({id:e.id,type:"group",name:e.name,x:S??0,y:n,width:a,height:i,group:e,index:t}),A[e.id]=e,n+=i,0!==t&&(n+=8),!e.isCollapsed)){let r=0;e.items.forEach(e=>{var t=Math.floor(r/R),i=r%R,t=n+t*(g+m);let d=a/R-c+c/R,o=0==i?S:i*(d+c)+S;f&&(g=d),y&&(d=a,o=S),s.vsGridItems.push({type:"item",id:e.id,name:e.name,x:o,y:t,width:d,height:g,item:e}),C[e.id]=e,r++}),n+=Math.ceil(e.items.length/R)*(g+m)}})}let e=function(){var t=w.scrollTop,i=w.clientHeight,d=(Math.floor(t/g),Math.ceil(i/g),[]),o=T(s.vsGridItems,Math.max(0,t-u),0,s.vsGridItems.length-1),r=T(s.vsGridItems,t+i+u,0,s.vsGridItems.length-1);for(let e=o;e<=r;e++){var a=s.vsGridItems[e];a&&a.y<t+i+u&&a.y+a.height>t-u&&d.push(a)}return d}(),d=e.filter(t=>!M.some(e=>e.id===t.id)),o=M.filter(t=>!e.some(e=>e.id===t.id));i=e.filter(t=>{var e=o.some(e=>e.id===t.id),i=d.some(e=>e.id===t.id);return!e&&!i});o.forEach(t=>{var e=a[0].querySelectorAll("[data-id]"),e=Array.from(e).find(e=>e.getAttribute("data-id")===encodeURIComponent(t.id));e&&(e.childNodes.forEach(e=>{angular.element(e).find("img, video").each((e,t)=>{t.src=""}),angular.element(e).scope().$destroy()}),e.remove())}),i.forEach(t=>{var e=a[0].querySelectorAll("[data-id]"),e=Array.from(e).find(e=>e.getAttribute("data-id")===encodeURIComponent(t.id));!e||b[t.id]&&b[t.id].top===t.y&&b[t.id].left===t.x&&b[t.id].width===t.width&&b[t.id].height===t.height||(e.style.width=t.width+"px",e.style.height=t.height+"px",e.style.top=t.y+"px",e.style.left=t.x+"px",void 0!==t.index&&e.setAttribute("index",t.index))}),d.forEach(i=>{let d=p.$new();"group"===i.type?n(d,e=>{d.group=A[i.id];var t=angular.element(`<div class="grid-group-label" data-id="${encodeURIComponent(i.id)}" style="transform: translateZ(0); top:${i.y}px; left: ${i.x}px; height: ${i.height}px; width: ${i.width}px;" index="${i.index}"></div>`);t.append(e[1]),a.append(t)}):"item"===i.type&&n(d,e=>{d.item=C[i.id];var t=angular.element(`<div class="grid-item" data-id="${encodeURIComponent(i.id)}" style="transform: translateZ(0); width:${i.width}px; height:${i.height}px; top:${i.y}px; left:${i.x}px;"></div>`);t.append(e[3]),a.append(t)})});let t=a[0].querySelector(".grid-placeholder");t?(E===1/0&&(E=100),I!==E&&(t.style.height=E+"px")):(t=angular.element(`<div class="grid-placeholder" style="height:${E}px; pointer-events: none;"></div>`),a.append(t)),I=E,M=e,b={},e.forEach(e=>{b[e.id]={top:e.y,left:e.x,width:e.width,height:e.height}})}}s.$watch("vsGridRepeatOptions",e=>{e&&(i=e,{columnWidth:h,columnHeight:g,columnGap:c,rowGap:m,extraRange:u,groupLabelHeight:v,squareMode:f,listMode:y,padding:d}=i,x=i.paddingTop??i.padding??0,G=i.paddingBottom??i.padding??0,S=i.paddingLeft??i.padding??0,$=i.paddingRight??i.padding??0,r({needReCalculate:!0}))},!0),p.$watchCollection(e,async e=>{p.groups=e,r({needReCalculate:!0})});{const H=new ResizeObserver(()=>{clearTimeout(void 0),setTimeout(()=>{p.$apply(()=>{r({needReCalculate:!0})})},100)});H.observe(w),s.$on("$destroy",()=>{H.disconnect()});{var l={onScrollStart:()=>{i.onScrollStart&&i.onScrollStart()},onScrollEnd:()=>{i.onScrollEnd&&i.onScrollEnd()}};let e,t=!1;a.on("scroll",()=>{!t&&l.onScrollStart&&(l.onScrollStart(),t=!0),clearTimeout(e),e=setTimeout(()=>{l.onScrollEnd&&l.onScrollEnd(),t=!1},100)})}let t;a.on("scroll",e=>{t=setTimeout(()=>{p.$apply(()=>{r()})},32)}),a.on("render",()=>{p.$evalAsync(r)})}r()}}}]);