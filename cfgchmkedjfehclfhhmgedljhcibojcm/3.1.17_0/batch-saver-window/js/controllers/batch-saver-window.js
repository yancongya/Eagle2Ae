"use strict";$(document).ready(function(){document.addEventListener("wheel",function(e){var t=e.target.closest("[allow-scroll]");t&&t.scrollHeight!=t.clientHeight||e.preventDefault()},{passive:!1})});let isMouseMoving,windowMouseX=0,windowMouseY=0,mousemoveTimeout;document.addEventListener("mousemove",e=>{windowMouseX=e.pageX,windowMouseY=e.pageY,isMouseMoving||(isMouseMoving=!0,clearTimeout(mousemoveTimeout),mousemoveTimeout=setTimeout(()=>{isMouseMoving=!1},500))},!1);const EagleApp=angular.module("BatchSaverApp",["folderSelectPanel","tagSelectPanel","i18n","tippy","contextMenu","ngRightClick","shortcut","vs-repeat","vsGridRepeat","vsAutoScroll","rectSelector","hoverPlayVideo"]);EagleApp.config(["$sceProvider","$httpProvider",(e,t)=>{e.enabled(!1)}]),EagleApp.filter("fuzzyMatch",()=>{return function(e,t){return t&&function(e,t){t=t.replace(/ /g,"").toLowerCase();for(var a=[],s=0,r=0;r<e.length;r++){var o=e[r];s<t.length&&o.toLowerCase()==t[s]&&(o="<b>"+o+"</b>",s+=1),a.push(o)}return s!=t.length?"":a.join("")}(e,t)||e}}),EagleApp.directive("lazyLoad",function(){return{restrict:"A",link:function(e,s,r){r.$observe("lazyLoad",e=>{if(e){const t=r.lazyLoad;if(-1!==t.indexOf("data:image"))s.attr("src",t),s.closest(".thumbnail").addClass("lazy-loaded");else{const a=new Image;a.src=t,a.onload=e=>{s.addClass("lazy-loaded"),s.attr("src",t),s.closest(".thumbnail").addClass("lazy-loaded"),a.onload=null},a.onerror=e=>{}}}})}}}),EagleApp.controller("BatchSaverWindowController",["$rootScope","$scope",(e,c)=>{{c.keyword="",c.theme="light",c.selectedTags=[],c.selectedFolders=[],c.extendTags=[],c.batchSaver=new BatchSaver;let s={},r=[];async function d(){var[e,t,a]=await Promise.all([eagle.folder.all(),eagle.folder.recent(),eagle.tag.all()]);c.folders=e,c.foldersMap={},c.recentFolders=t,c.tags=a?.tags||[],r=a||{},s={},c.recentFolders.forEach((e,t)=>{s[e.id]=t}),c.tagsMap=c.tags.reduce((e,t)=>(e[t.name]=t,e),{}),eagle.utils.tree.walk(c.folders,"children",(e,t)=>{c.foldersMap[e.id]=e})}e.getTheme=()=>"system"===e.preference.theme?e.preference.displayTheme:e.preference.theme,c.removeTag=e=>{e=c.selectedTags.indexOf(e);-1!==e&&c.selectedTags.splice(e,1)},c.removeFolder=e=>{e=c.selectedFolders.indexOf(e);-1!==e&&(c.selectedFolders.splice(e,1),c.extendTags=[...new Set(c.selectedFolders.map(e=>e.extendTags).flat())],c.$evalAsync())},c.download=()=>{var e=Object.values(c.batchSaver.selectedItems);if(0!==e.length){let a=(new Date).getTime()+e.length;const r={};var e=e.sort((t,a)=>{return c.batchSaver.items.findIndex(e=>e.id===t.id)-c.batchSaver.items.findIndex(e=>e.id===a.id)}).map(e=>{var t={src:e.src,type:e.type,title:(t=e.title,(r[t]?(r[t]+=1,`${t} (${r[t]})`):(r[t]=1,t))??e.title),url:e.url,duration:e.duration,annotation:e.annotation,modificationTime:a};return a-=1,t}),t=c.selectedTags,s=c.selectedFolders.map(e=>({id:e.id,extendTags:e.extendTags||[]}));window.parent.postMessage({channel:"batchSaver.downloadItems",images:e,tags:t,folders:s},"*")}},c.openTagSelect=()=>{var e=c.selectedTags.reduce((e,t)=>(e[t]=!0,e),{});TagSelectPanel.open({tagManager:{allTags:c.tags,groups:r?.groups||[],recentTags:r?.recent?.map(e=>e.name)||[],suggestions:[]},selectedTags:e,onAdd:e=>{e.forEach(e=>{c.tagsMap[e]=c.tagsMap[e]||{name:e,color:"",groups:[]}}),c.selectedTags=[...new Set([...c.selectedTags,...e])],c.$evalAsync()},onRemove:t=>{c.selectedTags=c.selectedTags.filter(e=>!t.includes(e)),c.$evalAsync()},onChanged:e=>{c.$evalAsync()},onClosed:()=>{}})},c.openFolderSelect=()=>{var e=c.selectedFolders.reduce((e,t)=>(e[t.id]=!0,e),{});FolderSelectPanel.open({recentFolderOrders:s,folders:c.folders,selectedIds:e,onChanged:e=>{const t=e["selectedFolderIds"];e=Object.keys(t).filter(e=>t[e]).map(e=>c.foldersMap[e]);c.selectedFolders=e,c.extendTags=[...new Set(c.selectedFolders.map(e=>e.extendTags).flat())]},onCreateItem:async(e,t)=>{window.parent.postMessage({channel:"batchSaver.createFolder",folderName:e,parent:t},"*")}})},c.focusSearchInput=()=>{var e=document.querySelector("#keyword-input");e&&e.focus()},c.toggleItem=async(e,t)=>{if(e.preventDefault(),e.stopPropagation(),e.shiftKey){var e=c.lastSelectedIndex,a=t.index,s=Math.min(e,a),r=Math.max(e,a);for(let e=s;e<=r;e++){const t=c.batchSaver.items[e];t&&c.batchSaver.selectItem(t)}}else c.batchSaver.toggleItem(t),c.lastSelectedIndex=t.index;c.$evalAsync()},c.onSelection=e=>{if(c.batchSaver.resetTemporarySelectedItems(),e)for(var t of e)c.batchSaver.addTemporarySelectedItem(t.item)},c.onSelectionEnd=(e,t)=>{var a=e.ctrlKey||e.metaKey,e=e.shiftKey;a||e?t.map(e=>e.item).forEach(t=>{var e=c.batchSaver.items.find(e=>e.id===t.id);e&&c.batchSaver.selectItem(e)}):(c.batchSaver.resetSelectedItems(),t.map(e=>e.item).forEach(t=>{var e=c.batchSaver.items.find(e=>e.id===t.id);e&&c.batchSaver.selectItem(e)})),c.batchSaver.temporarySelectedItems={},c.$evalAsync()},c.clickOnGrid=e=>{c.batchSaver.resetSelectedItems(e)},c.lastMouseX=0,c.lastMouseY=0,c.mouseDownOnGrid=e=>{c.lastMouseX=e.clientX,c.lastMouseY=e.clientY},c.mouseUpOnGrid=e=>{var t=e.clientX,a=e.clientY,t=c.lastMouseX===t&&c.lastMouseY===a,a="grid-container"===e.target.id;t&&a&&c.clickOnGrid(e)},c.showDomainFilter=()=>1<Object.keys(c.batchSaver.filter.domain.available).length,c.closeWindow=()=>{window.parent.postMessage({channel:"batchSaver.closeWindow"},"*")},c.startAutoDetect=()=>{var e;c.isAutoDetectMode||(e=c.batchSaver.items.map(e=>e.src),window.parent.postMessage({channel:"batchSaver.startDetectMode",originalSrcs:e},"*"),c.isAutoDetectMode=!0)},(async()=>{e.preference=eagle.preference,await e.preference.init(),await eagle.i18n.init(),e.$evalAsync(),c.theme=e.getTheme(),Mousetrap.bind("mod+a",e=>{c.batchSaver.selectAll(),c.$evalAsync(),e.preventDefault()}),Mousetrap.bind("mod+f",e=>{e.preventDefault(),c.focusSearchInput()}),Mousetrap.bind("mod+enter",e=>{c.download(),c.$evalAsync(),e.preventDefault()}),Mousetrap.bind("esc",()=>{0===Object.keys(c.batchSaver.selectedItems).length&&c.closeWindow(),c.batchSaver.resetSelectedItems(),c.$evalAsync()}),Mousetrap.bind("mod+=",e=>{e.preventDefault(),c.batchSaver.zoomIn(),c.$evalAsync()}),Mousetrap.bind("mod+-",e=>{e.preventDefault(),c.batchSaver.zoomOut(),c.$evalAsync()}),Mousetrap.bind("mod+0",e=>{e.preventDefault(),c.batchSaver.zoomDefault(),c.$evalAsync()}),Mousetrap.bind("d",e=>{e.preventDefault(),c.startAutoDetect(),c.$evalAsync()}),Mousetrap.bind("t",e=>{e.preventDefault(),c.openTagSelect(),c.$evalAsync()}),Mousetrap.bind("f",e=>{e.preventDefault(),c.openFolderSelect(),c.$evalAsync()});{const t=eagle.utils.throttle(function(){c.batchSaver.zoomIn()},120),a=eagle.utils.throttle(function(){c.batchSaver.zoomOut()},120);document.addEventListener("wheel",function(e){(e.ctrlKey||e.metaKey||e.altKey)&&(e.preventDefault(),e.deltaY<0?t():0<e.deltaY&&a(),c.$evalAsync())},{passive:!1})}await d(),window.addEventListener("message",async e=>{if(!1!==e.isTrusted&&e.source===window.parent){var t=e.data.channel;if("batchSaver.sendItems"==t){var a=e.data.items;const r=eagle.utils.throttle(()=>{c.batchSaver.update(),c.$evalAsync()},50,!0);a=a.map((e,t)=>{e.src.includes("video/")&&(e.type="video");e=new BatchSaverItem(e);return e.ready(e=>{r()}),e});c.batchSaver.addItems(a),c.batchSaver.update(),c.$evalAsync()}else if("batchSaver.stopDetectMode"==t)setTimeout(()=>{c.isAutoDetectMode=!1,c.batchSaver.update(),c.$evalAsync()},100);else if("batchSaver.updateBatchSaverItem"==t){const{src:o,base64:n}=e.data;a=c.batchSaver.items.find(e=>e.src===o);if(a){a.base64=n,a.src=n;try{-1!=n.indexOf("video/")?(a.type="video",a.ext=a.base64.split("/")[1].split(";")[0]):await a.updateImageSize(n),a.status="done"}catch(e){a.status="error"}try{a.updateResolution()}catch(e){}c.batchSaver.update(),c.$evalAsync()}}else if("batchSaver.createFolderResponse"==t){var a=e.data.folderName;a&&(s=e.data.parent,a=await eagle.folder.create(a,s),c.selectedFolders.push(a),await d(),FolderSelectPanel.close(),c.$evalAsync())}else if("batchSaver.removeBatchSaverItem"==t){const l=e?.data?.src;var s=c.batchSaver.rawItems.find(e=>e.src===l);s&&(c.batchSaver.removeItem(s),c.$evalAsync())}}},!1),window.parent.postMessage({channel:"batchSaver.iframeReady"},"*"),c.isOpen=!0})()}}]);