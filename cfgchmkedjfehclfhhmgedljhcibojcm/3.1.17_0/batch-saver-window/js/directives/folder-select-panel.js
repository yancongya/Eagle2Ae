class FolderSelectPanel extends SelectPanel{originalParams;searchKeyword;rawData;onChanged;onCreateItem;collapsedFolderIds={};static open(e){angular.element("html").scope().$broadcast("FOLDER.SELECT.PANEL.OPEN",e)}static close(){angular.element("html").scope().$broadcast("FOLDER.SELECT.PANEL.CLOSE")}constructor(e){super(e),this.collapsedFolderIds={}}init(e){this.originalParams=e,super.init(e),this.reset(),this.initRawData(e),this.updateItemList(),this.onCreateItem=e.onCreateItem||(()=>{}),this.onChanged=e.onChanged||(()=>{})}reset(){if(super.reset(),localStorage["eagle.folderSelectPanel.collapsedFolderIds"])try{this.collapsedFolderIds=JSON.parse(localStorage["eagle.folderSelectPanel.collapsedFolderIds"])}catch(e){this.collapsedFolderIds={}}this.listData.selectedIds={},this.listData.currentTab="ALL",this.rawData={folders:[],selectedIds:{},recentFolderOrders:{},folderList:[],foldersMap:{},foldersDepthMap:{}}}initRawData(e){let c={};this.rawData={folders:e.folders||[],selectedIds:e.selectedIds||{},recentFolderOrders:e.recentFolderOrders||{},folderList:[],foldersMap:{},folderItemsMap:{},foldersDepthMap:{}},this.listData.maxDepth=0,eagle.utils.tree.walk(this.rawData.folders,"children",(e,t,a)=>{var{id:s,name:i,icon:l,iconColor:r,pinyin:d}=e;this.rawData.folderList.push(e),this.rawData.foldersMap[s]=e,this.rawData.foldersDepthMap[s]=a;let o=[];o=t&&c[t.id]?[...c[t.id],e.iconColor||"normal"]:[e.iconColor||"normal"],c[e.id]=o;var n=e.children&&0<e.children.length,i={type:"folder",id:s,name:i,pinyin:d,path:this.getFolderParentPath(e),extendTags:e.extendTags,icon:l,iconColor:r,depth:this.rawData.foldersDepthMap[s],size:26,parent:t?.id,parentItem:this.rawData.folderItemsMap[t?.id],guidelines:o,hasChildren:n};this.rawData.folderItemsMap[s]=i,this.listData.maxDepth<a&&(this.listData.maxDepth=a)}),this.listData.selectedIds={...this.rawData.selectedIds}}updateItemList(e=!1){e||(this.listData.currentIndex=-1),this.listData.items=[];const l=this.listData.searchKeyword;var t=this.rawData.folderList;let r=""!==l,d=[],o=[],n=5;if(t.forEach(e=>{var{id:e,name:t}=e,a=this.rawData.folderItemsMap[e],s={...a},i=this.listData.selectedIds[e];i&&n++,(0<=this.rawData.recentFolderOrders[e]||i)&&((e={...a}).depth=0,e.isRecent=!0,o.push(e)),(l||this.isVisible(s))&&d.push(s),t===l&&(r=!1)}),o=(o=(o=o.sort((e,t)=>{e=this.rawData.recentFolderOrders[e.id],t=this.rawData.recentFolderOrders[t.id];return e<t?-1:t<e?1:0})).sort((e,t)=>this.rawData.selectedIds[e.id]&&!this.rawData.selectedIds[t.id]?-1:!this.rawData.selectedIds[e.id]&&this.rawData.selectedIds[t.id]?1:0)).sort((e,t)=>this.listData.selectedIds[e.id]&&!this.listData.selectedIds[t.id]?-1:!this.listData.selectedIds[e.id]&&this.listData.selectedIds[t.id]?1:0),"ALL"===this.listData.currentTab){let e=this.filterByKeyword(o);e=e.slice(0,n),d=this.filterByKeyword(d),""!==l&&(d=d.filter(t=>!e.find(e=>e.id===t.id))),0<e.length?0<d.length?this.listData.items=[...e,{type:"separator",size:5},...d]:this.listData.items=[...e]:this.listData.items=[...d]}else"RECENT"===this.listData.currentTab?(o=this.filterByKeyword(o),this.listData.items=[...o.slice(0,20)]):"SELECTED"===this.listData.currentTab&&(d=d.filter(e=>this.listData.selectedIds[e.id]),this.listData.items=[...d]);r&&(0<this.listData.items.length?this.listData.items=[...this.listData.items,{type:"separator",size:5},{type:"create",size:26,name:l}]:this.listData.items=[{type:"create",size:26,name:l}]),this.listData.items.forEach((e,t)=>{e.index=t}),e||(""!==l&&0<this.listData.items.length?this.listData.currentIndex=0:this.listData.currentIndex=-1)}isVisible(e){var t,e=e.parent;return!e||!!(t=this.rawData.folderItemsMap[e])&&!this.collapsedFolderIds[e]&&this.isVisible(t)}filterByKeyword(e){if(0!==this.listData.searchKeyword.length){const a=chineseConvert.tw2cn(this.listData.searchKeyword).trim();var t=(e=e.map(e=>{var t=chineseConvert.tw2cn(e.name);return 30<=e.name.length?{item:e,name:t,search:[t]}:{item:e,name:t,search:[t,...new Set(cartesianProduct(pinyinlite(t,{keepUnrecognized:!0}).filter(e=>0<e.length)).map(e=>e.join(" ")))]}}).map(e=>{return{item:e,name:`${e.name??""} `+(e.keywords??""),score:Math.max(...e.search.map(e=>e.score(a)))}}).filter(e=>0<e.score).sort((e,t)=>t.score-e.score).map(function(e){return e.item.item})).reduce((e,t)=>((t.name.toLowerCase().startsWith(this.listData.searchKeyword.toLowerCase())?e.startWithKeyword:e.notStartWithKeyword).push(t),e),{startWithKeyword:[],notStartWithKeyword:[]});e=[...t.startWithKeyword,...t.notStartWithKeyword]}return e}getCallbackResult(){var e,a,t;return e=this.rawData.selectedIds,a=this.listData.selectedIds,e=Object.entries(e),t=Object.entries(a),{isDirty:!(e.length===t.length&&e.every(([e,t])=>a[e]===t)),selectedFolderIds:{...this.listData.selectedIds},deselectedFolderIds:Object.entries(this.rawData.selectedIds).reduce((e,[t])=>(this.listData.selectedIds[t]||(e[t]=!0),e),{})}}getFolderParentPath(e){var e=this.rawData.foldersMap[e.parent],t=this.rawData.foldersMap[e?.parent],a=this.rawData.foldersMap[t?.parent],e=e?.name,t=t?.name,a=a?.name;let s="";return a&&t&&e?s=`../<span>${t}</span>/<span>${e}</span>`:!a&&t&&e?s=`<span>${t}</span>/<span>${e}</span>`:a||t||!e||(s=""+e),s}close(){var e=this.getCallbackResult();e.isDirty&&this.onChanged(e),super.close(),this.reset()}onTabKey(){"ALL"===this.listData.currentTab?this.listData.currentTab="RECENT":"RECENT"===this.listData.currentTab?this.listData.currentTab="SELECTED":"SELECTED"===this.listData.currentTab&&(this.listData.currentTab="ALL"),this.updateItemList()}openItem(e,t){var a;"create"===t.type?this.onCreateItem(this.listData.searchKeyword.trim()):(e=e?.ctrlKey||e?.metaKey,t=t.id,(a=this.listData.selectedIds)[t]?delete a[t]:a[t]=!0,""===this.listData.searchKeyword||e||(this.listData.searchKeyword="",this.clearSearchInput(),this.updateItemList()))}openItemSubmenu(e){e.isRecent||ContextMenu.open({items:[{label:eagle.i18n.words["selectFolderPanel.context.addChilderFolder"],icon:"ic-folder-new-sub-folder.svg",click:()=>{this.onCreateItem(this.listData.searchKeyword.trim(),e.id)}},{label:eagle.i18n.words["selectFolderPanel.context.addSiblingFolder"],icon:"ic-expand-same.svg",click:()=>{this.onCreateItem(this.listData.searchKeyword.trim(),e.parent)}}],onClosed:()=>{this.focusSearchInput()}})}changeTab(e){this.listData.currentTab=e,this.updateItemList()}keywordChanged(){this.updateItemList()}isItemSelectable(e){return{folder:!0,create:!0}[e.type]}createFolder(e="",t){swal({html:`
				<div class="alert">
					<div class="alert-icon create"></div>
					<h4 class="alert-title">${i18n.__("selectFolderPanel.createFolder.title")}</h4>
				</div>
			`,showCloseButton:!1,showCancelButton:!0,allowOutsideClick:!1,focusConfirm:!0,focusCancel:!1,padding:24,width:400,customClass:"alert-box",input:"text",inputPlaceholder:i18n.__("selectFolderPanel.createFolder.placeholder"),inputValue:e,cancelButtonColor:"#777777",confirmButtonText:i18n.__("selectFolderPanel.createFolder.button"),cancelButtonText:i18n.__("general.cancel")}).then(e=>{t(e),this.focusSearchInput()},()=>{this.focusSearchInput()})}onCreatedFolder(e){var t={...this.listData.selectedIds};t[e.id]=!0,this.reset(),this.init(this.originalParams),this.listData.selectedIds=t,this.updateItemList()}toggleExpand(e){this.collapsedFolderIds[e.id]?this.expand(e):this.collapse(e)}expand(e){delete this.collapsedFolderIds[e.id],this.updateItemList(!0);try{localStorage["eagle.folderSelectPanel.collapsedFolderIds"]=JSON.stringify(this.collapsedFolderIds)}catch(e){}}collapse(e){this.collapsedFolderIds[e.id]=!0,this.updateItemList(!0);try{localStorage["eagle.folderSelectPanel.collapsedFolderIds"]=JSON.stringify(this.collapsedFolderIds)}catch(e){}}onLeftKey(){var e=this.listData.items[this.listData.currentIndex];e&&"folder"===e.type&&this.collapse(e)}onRightKey(){var e=this.listData.items[this.listData.currentIndex];e&&"folder"===e.type&&this.expand(e)}}angular.module("folderSelectPanel",[]).directive("folderSelectPanel",["$timeout",i=>({restrict:"E",templateUrl:"js/directives/folder-select-panel.html",replace:!1,scope:{theme:"=theme"},link:a=>{const s=new FolderSelectPanel({scope:a,panelSelector:"#folder-select-panel",searchInputSelector:"#folder-select-panel-search-input",onSelectChanged:e=>{"keyboard"===e.type&&a.$broadcast("VS-REPEAT-AUTO-SCROLL",e.index)}});a.$on("FOLDER.SELECT.PANEL.CLOSE",()=>{s.close()}),a.$on("FOLDER.SELECT.PANEL.OPEN",(e,t)=>{s.init(t),i(()=>{s.open()},50),Object.assign(a,{collapsedFolderIds:s.collapsedFolderIds,listData:s.listData,toggleExpand:e=>{s.toggleExpand(e)},expand:e=>{s.expand(e)},collapse:e=>{s.collapse(e)},openItem:(e,t)=>{s.openItem(e,t)},openItemSubmenu:e=>{s.openItemSubmenu(e)},hoverItem:e=>{s.hoverItem(e.index)},close:()=>{s.close()},focusSearchInput:()=>{s.focusSearchInput()},changeTab:e=>{s.changeTab(e)}})})}})]);