"use strict";let isMouseDownOnBody=!1;function closeWindow(){window.parent.postMessage({channel:"iframe-closed"},"*")}document.body.addEventListener("mousedown",e=>{e.target===document.body&&(isMouseDownOnBody=!0)}),document.body.addEventListener("mouseup",e=>{isMouseDownOnBody&&e.target===document.body&&closeWindow(),isMouseDownOnBody=!1}),$(document).ready(function(){document.addEventListener("wheel",function(e){var t=e.target.closest("[allow-scroll]");t&&t.scrollHeight!=t.clientHeight||e.preventDefault()},{passive:!1})});let isMouseMoving,windowMouseX=0,windowMouseY=0,mousemoveTimeout;document.addEventListener("mousemove",e=>{windowMouseX=e.pageX,windowMouseY=e.pageY,isMouseMoving||(isMouseMoving=!0,clearTimeout(mousemoveTimeout),mousemoveTimeout=setTimeout(()=>{isMouseMoving=!1},500))},!1);const EagleApp=angular.module("CollectApp",["folderSelectPanel","tagSelectPanel","i18n","tippy","ngRightClick","contenteditable","stopWheel","vs-repeat","vsGridRepeat","contextMenu","vsAutoScroll"]);EagleApp.config(["$sceProvider","$httpProvider",(e,t)=>{e.enabled(!1)}]),EagleApp.filter("fuzzyMatch",()=>{return function(e,t){return t&&function(e,t){t=t.replace(/ /g,"").toLowerCase();for(var o=[],a=0,l=0;l<e.length;l++){var c=e[l];a<t.length&&c.toLowerCase()==t[a]&&(c="<b>"+c+"</b>",a+=1),o.push(c)}return a!=t.length?"":o.join("")}(e,t)||e}}),window.onload=async function(){if(eagle.env.isSafari){const t=setInterval(()=>{var e=document.querySelector("#folder-select-panel-search-input");e&&(document?.activeElement?.isContentEditable?(document.activeElement.focus(),clearInterval(t)):(e.focus(),e===document.activeElement&&clearInterval(t)))},100)}},EagleApp.directive("lazyLoad",function(){return{restrict:"A",link:function(e,a,l){l.$observe("lazyLoad",e=>{if(e){const t=l.lazyLoad;if(-1!==t.indexOf("data:image"))a.attr("src",t),a.closest(".thumbnail").addClass("lazy-loaded");else{const o=new Image;o.src=t,o.onload=e=>{a.addClass("lazy-loaded"),a.attr("src",t),a.closest(".thumbnail").addClass("lazy-loaded"),o.onload=null},o.onerror=e=>{}}}})}}}),EagleApp.controller("CollectController",["$rootScope","$scope","$timeout",(n,s,e)=>{{let a={},l=[];function o(o){const a=["title","annotation","tags","folderIDs","star","src"];return Object.keys(o).reduce((e,t)=>(a.includes(t)&&(e[t]=o[t]),e),{})}async function t(){var[e,t,o]=await Promise.all([eagle.folder.all(),eagle.folder.recent(),eagle.tag.all()]);s.folders=e,s.foldersMap={},s.recentFolders=t,s.tags=o?.tags||[],l=o||{},a={},s.recentFolders.forEach((e,t)=>{a[e.id]=t}),s.tagsMap=s.tags.reduce((e,t)=>(e[t.name]=t,e),{}),eagle.utils.tree.walk(s.folders,"children",(e,t)=>{s.foldersMap[e.id]=e}),s.isLoadingData=!1,s.initFolderSelect()}n.getTheme=()=>"system"===n.preference.theme?n.preference.displayTheme:n.preference.theme,s.changeStar=e=>{e&&e!==s.collectItem.star?s.collectItem.star=e:delete s.collectItem.star},s.removeTag=e=>{e=s.collectItem.tags.indexOf(e);-1!==e&&s.collectItem.tags.splice(e,1)},s.openTagSelect=()=>{TagSelectPanel.open({preventCollisionWithElement:document.querySelector("div.fake-thumbnail"),tagManager:{allTags:s.tags,groups:l?.groups||[],recentTags:l?.recent?.map(e=>e.name)||[],suggestions:[]},selectedTags:s.collectItem.tags.reduce((e,t)=>(e[t]=!0,e),{}),onAdd:e=>{e.forEach(e=>{s.tagsMap[e]=s.tagsMap[e]||{name:e,color:"",groups:[]}}),s.collectItem.tags=[...new Set([...s.collectItem.tags,...e])],s.$evalAsync()},onRemove:t=>{s.collectItem.tags=s.collectItem.tags.filter(e=>!t.includes(e)),s.$evalAsync()},onChanged:e=>{s.$evalAsync()},onClosed:()=>{s.focusFolderInput()}})},s.focusFolderInput=()=>{e(()=>{var e=document.querySelector("#folder-select-panel-search-input");e&&e.focus()},100)},s.initFolderSelect=()=>{FolderSelectPanel.open({recentFolderOrders:a,folders:s.folders,selectedIds:[],onOpenItem:async e=>{if(!s.isLoadingData){let t=o(s.collectItem);e instanceof Array?(t.folderIDs=e).forEach(e=>{e=s.foldersMap[e];e&&e.extendTags instanceof Array&&(t.tags=[...new Set([...t.tags,...e.extendTags])])}):(e.id&&(t.folderIDs=[e.id]),e.extendTags instanceof Array&&(t.tags=[...new Set([...t.tags,...e.extendTags])])),window.parent.postMessage({channel:"collect-item",result:t},"*")}},onCreateItem:async e=>{var t=o(s.collectItem);window.parent.postMessage({channel:"open-create-folder-dialog",collectItem:t,item:e,parent:e.parent},"*")},onLibrarySwitching:()=>{s.isLoadingData=!0},onLibrarySwitched:()=>{t()},onLibrarySwitchClosed:()=>{s.focusFolderInput()},onEscKey:()=>{closeWindow()}})},(async()=>{n.preference=eagle.preference,await n.preference.init(),await eagle.i18n.init(),n.$evalAsync(),s.browserName=eagle.env.browser.name,s.theme=n.getTheme(),s.isOpen=!1,s.collectItem=new CollectItem,await t(),window.addEventListener("message",async e=>{if(!1!==e.isTrusted&&e.source===window.parent){var t,o,a,l,c=e.data.channel;if("update-theme"==c&&(s.theme=n.getTheme(),s.$evalAsync()),"cancel-create-folder-dialog"==c&&s.focusFolderInput(),"preview-meta"==c){s.collectItem.width=e.data.width,s.collectItem.height=e.data.height,s.collectItem.type=e.data.type||"image",s.collectItem.src=e.data.src,s.collectItem.title=e.data.title,s.collectItem.annotation=e.data.annotation,s.collectItem.tags=e.data.tags||[],s.collectItem.status="pending",s.collectItem.tags.map((e,t)=>{s.tagsMap[e]=s.tagsMap[e]||{name:e,color:"",groups:[]}});try{"image"===s.collectItem.type&&({width:t,height:o}=await s.collectItem.updateImageSize(s.collectItem.src),s.collectItem.width=t,s.collectItem.height=o),"video"===s.collectItem.type&&({width:a,height:l}=await s.collectItem.updateVideoSize(s.collectItem.src),s.collectItem.width=a,s.collectItem.height=l),s.$evalAsync(),window.parent.postMessage({channel:"collectWindow.enlargeUrl",src:s.collectItem.src},"*")}catch{window.parent.postMessage({channel:"collectWindow.covertToBase64",src:s.collectItem.src},"*")}s.$evalAsync()}"collectWindow.enlargeUrlResponse"!=c&&"collectWindow.covertToBase64Response"!=c||({src:t,base64:o}=e.data,t===s.collectItem.src&&o&&((s.collectItem.src=o).includes("video/")?({width:a,height:l}=await s.collectItem.updateVideoSize(o),s.collectItem.width=a,s.collectItem.height=l):o.includes("image/")&&({width:c,height:e}=await s.collectItem.updateImageSize(o),s.collectItem.width=c,s.collectItem.height=e)),s.collectItem.status="done",s.$evalAsync())}},!1),window.parent.postMessage({channel:"iframe-ready"},"*"),s.isOpen=!0})()}}]);