<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CEP文件系统测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input[type="text"] {
            width: 500px;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>CEP文件系统测试</h1>
        
        <div class="test-section">
            <h3>1. 文件路径测试</h3>
            <p>测试CEP环境中的文件访问</p>
            <input type="text" id="test-file-path" placeholder="输入文件路径，例如：E:/test/file.png" 
                   value="E:/工作/202508/20250819 33440钻- 雾拢百妖/33440钻- 雾拢百妖_Export_20250819_130623/耳朵1.png">
            <br>
            <button class="test-button" onclick="testFilePath()">测试文件</button>
            <div id="file-result"></div>
        </div>

        <div class="test-section">
            <h3>2. 目录测试</h3>
            <p>测试目录访问和文件列表</p>
            <input type="text" id="test-dir-path" placeholder="输入目录路径" 
                   value="E:/工作/202508/20250819 33440钻- 雾拢百妖/33440钻- 雾拢百妖_Export_20250819_130623">
            <br>
            <button class="test-button" onclick="testDirectory()">测试目录</button>
            <div id="dir-result"></div>
        </div>

        <div class="test-section">
            <h3>3. URL解码测试</h3>
            <p>测试文件名URL解码</p>
            <input type="text" id="encoded-name" placeholder="输入编码的文件名" 
                   value="%E8%80%B3%E6%9C%B51.png">
            <br>
            <button class="test-button" onclick="testDecoding()">测试解码</button>
            <div id="decode-result"></div>
        </div>

        <div class="test-section">
            <h3>4. 复制功能模拟测试</h3>
            <p>模拟完整的复制流程</p>
            <button class="test-button" onclick="testCopyFlow()">模拟复制流程</button>
            <div id="copy-result"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(message);
            return `<div class="${type}">${message}</div>`;
        }

        function testFilePath() {
            const resultDiv = document.getElementById('file-result');
            const filePath = document.getElementById('test-file-path').value;
            
            if (!filePath) {
                resultDiv.innerHTML = log('请输入文件路径', 'error');
                return;
            }
            
            let result = '';
            
            try {
                // 测试File对象
                const file = new File(filePath);
                result += log(`文件路径: ${filePath}`, 'info');
                result += log(`文件存在: ${file.exists}`, file.exists ? 'success' : 'error');
                
                if (file.exists) {
                    result += log(`文件名: ${file.name}`, 'info');
                    result += log(`文件大小: ${file.length} 字节`, 'info');
                    result += log(`修改时间: ${file.modified}`, 'info');
                }
                
            } catch (error) {
                result += log(`文件测试失败: ${error.message}`, 'error');
            }
            
            resultDiv.innerHTML = result;
        }

        function testDirectory() {
            const resultDiv = document.getElementById('dir-result');
            const dirPath = document.getElementById('test-dir-path').value;
            
            if (!dirPath) {
                resultDiv.innerHTML = log('请输入目录路径', 'error');
                return;
            }
            
            let result = '';
            
            try {
                // 测试Folder对象
                const folder = new Folder(dirPath);
                result += log(`目录路径: ${dirPath}`, 'info');
                result += log(`目录存在: ${folder.exists}`, folder.exists ? 'success' : 'error');
                
                if (folder.exists) {
                    try {
                        const files = folder.getFiles('*.png');
                        result += log(`PNG文件数量: ${files.length}`, 'info');
                        
                        if (files.length > 0) {
                            const fileNames = files.slice(0, 10).map(f => f.name);
                            result += log(`文件列表: ${fileNames.join(', ')}${files.length > 10 ? '...' : ''}`, 'info');
                        }
                    } catch (listError) {
                        result += log(`列出文件失败: ${listError.message}`, 'error');
                    }
                }
                
            } catch (error) {
                result += log(`目录测试失败: ${error.message}`, 'error');
            }
            
            resultDiv.innerHTML = result;
        }

        function testDecoding() {
            const resultDiv = document.getElementById('decode-result');
            const encodedName = document.getElementById('encoded-name').value;
            
            if (!encodedName) {
                resultDiv.innerHTML = log('请输入编码的文件名', 'error');
                return;
            }
            
            let result = '';
            
            try {
                result += log(`原始文件名: ${encodedName}`, 'info');
                
                if (encodedName.includes('%')) {
                    const decoded = decodeURIComponent(encodedName);
                    result += log(`解码后文件名: ${decoded}`, 'success');
                    
                    // 测试重新编码
                    const reencoded = encodeURIComponent(decoded);
                    result += log(`重新编码: ${reencoded}`, 'info');
                    result += log(`编码匹配: ${reencoded === encodedName}`, reencoded === encodedName ? 'success' : 'error');
                } else {
                    result += log('文件名不包含URL编码', 'info');
                }
                
            } catch (error) {
                result += log(`解码测试失败: ${error.message}`, 'error');
            }
            
            resultDiv.innerHTML = result;
        }

        function testCopyFlow() {
            const resultDiv = document.getElementById('copy-result');
            
            // 模拟导出数据
            const mockExportInfo = {
                exportPath: 'E:/工作/202508/20250819 33440钻- 雾拢百妖/33440钻- 雾拢百妖_Export_20250819_130623',
                exportedLayers: [
                    {
                        fileName: '%E8%80%B3%E6%9C%B51.png',
                        layerName: '耳朵1'
                    },
                    {
                        fileName: '%E5%A4%B4.png',
                        layerName: '头'
                    }
                ]
            };
            
            let result = '';
            result += log('=== 模拟复制流程 ===', 'info');
            result += log(`导出路径: ${mockExportInfo.exportPath}`, 'info');
            
            // 构建文件路径
            const filePaths = mockExportInfo.exportedLayers.map((layer, index) => {
                let fileName = layer.fileName || `${layer.layerName || 'unknown'}.png`;
                
                // URL解码
                if (fileName.includes('%')) {
                    try {
                        const originalName = fileName;
                        fileName = decodeURIComponent(fileName);
                        result += log(`解码文件名 ${index + 1}: ${originalName} -> ${fileName}`, 'success');
                    } catch (decodeError) {
                        result += log(`解码失败 ${index + 1}: ${fileName}`, 'error');
                    }
                }
                
                // 构建完整路径
                let fullPath = mockExportInfo.exportPath;
                if (!fullPath.endsWith('/') && !fullPath.endsWith('\\')) {
                    fullPath += '/';
                }
                fullPath += fileName;
                fullPath = fullPath.replace(/\\/g, '/');
                
                return fullPath;
            });
            
            result += log(`构建的文件路径:`, 'info');
            filePaths.forEach((path, index) => {
                result += log(`  ${index + 1}. ${path}`, 'info');
                
                // 检查文件是否存在
                try {
                    const file = new File(path);
                    result += log(`     文件存在: ${file.exists}`, file.exists ? 'success' : 'error');
                } catch (error) {
                    result += log(`     检查失败: ${error.message}`, 'error');
                }
            });
            
            resultDiv.innerHTML = result;
        }
    </script>
</body>
</html>
