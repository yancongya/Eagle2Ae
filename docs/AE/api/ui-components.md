# AE插件UI组件详细说明

## 概述

Eagle2Ae AE插件面板提供了完整的用户界面，用于管理Eagle与After Effects之间的文件传输和项目集成。本文档详细说明每个UI组件的功能、参数和运行逻辑。

## 插件面板整体布局

### 主要区域划分

```
┌─────────────────────────────────────┐
│ 标题栏 (Header)                      │
├─────────────────────────────────────┤
│ 项目信息面板 (Project Info)          │
├─────────────────────────────────────┤
│ 导入模式&行为面板 (Import Settings)   │
├─────────────────────────────────────┤
│ 状态信息面板 (Status Panel)          │
├─────────────────────────────────────┤
│ 日志面板 (Log Panel)                │
└─────────────────────────────────────┘
```

## 1. 标题栏组件 (Header)

### 1.1 应用标题
- **组件**: `.title` 区域
- **功能**: 显示插件名称和Logo
- **元素**:
  - Logo图片: `public/logo.png`
  - 动画文字: "Eagle2Ae" 每个字符独立动画
- **样式特性**: 字符悬浮动画效果

### 1.2 头部操作按钮

#### 日志面板切换按钮
- **ID**: `log-panel-toggle`
- **图标**: 📄
- **功能**: 显示/隐藏日志面板
- **运行逻辑**:
  ```javascript
  // 切换日志面板可见性
  toggleLogPanel() {
    const logSection = document.querySelector('.section.log');
    logSection.style.display = logSection.style.display === 'none' ? 'block' : 'none';
  }
  ```

#### 高级设置按钮
- **ID**: `settings-btn`
- **图标**: ⚙️
- **功能**: 打开高级设置面板
- **运行逻辑**: 显示模态设置对话框

## 2. 项目信息面板 (Project Info)

### 2.1 连接状态按钮
- **ID**: `test-connection-btn`
- **功能**: 测试与Eagle插件的连接状态
- **组件结构**:
  - 状态指示器: `#status-indicator`
  - 主状态文本: `#status-main`
  - 延迟显示: `#ping-time`

#### 状态类型
- **未连接**: 灰色指示器，显示"未连接"
- **连接中**: 黄色指示器，显示"连接中"
- **已连接**: 绿色指示器，显示"已连接"和延迟时间
- **连接失败**: 红色指示器，显示"连接失败"

### 2.2 After Effects信息区域
- **版本信息**: `#ae-version` - 显示AE版本号
- **项目路径**: `#project-path` - 当前项目文件路径
- **项目名称**: `#project-name` - 当前打开的项目名
- **合成名称**: `#comp-name` - 当前活动合成名

### 2.3 Eagle信息区域
- **版本信息**: `#eagle-version` - Eagle应用版本
- **应用路径**: `#eagle-path` - Eagle安装路径
- **资源库**: `#eagle-library` - 当前资源库名称
- **当前组**: `#eagle-folder` - 当前选中的文件夹

## 3. 导入模式&行为面板

### 3.1 导入模式选择

#### 直接导入模式
- **值**: `direct`
- **功能**: 从Eagle源目录直接导入到AE项目
- **特点**: 不复制文件，直接引用原始路径
- **适用场景**: 文件已在合适位置，无需移动

#### 项目旁复制模式
- **值**: `project_adjacent`
- **功能**: 复制文件到AE项目文件旁边的指定文件夹
- **默认状态**: 选中状态
- **配置**: 可设置文件夹名称（默认：Eagle_Assets）

#### 指定文件夹模式
- **值**: `custom_folder`
- **功能**: 复制文件到用户指定的任意文件夹
- **配置**: 需要设置目标文件夹路径

### 3.2 导入行为设置

#### 不导入合成
- **值**: `no_import`
- **功能**: 仅导入到项目面板，不添加到合成
- **适用场景**: 批量导入素材，稍后手动添加

#### 当前时间导入
- **值**: `current_time`
- **功能**: 将素材放置在时间轴当前时间指针位置
- **默认状态**: 选中状态

#### 时间轴开始导入
- **值**: `timeline_start`
- **功能**: 将素材移至时间轴开始处（0秒位置）
- **适用场景**: 素材作为背景或基础层

### 3.3 图层操作按钮组

#### 检测图层按钮
- **ID**: `detect-layers-btn`
- **功能**: 扫描当前合成中的所有图层
- **运行逻辑**:
  ```javascript
  detectLayers() {
    // 调用ExtendScript获取图层信息
    csInterface.evalScript('getCompositionLayers()', (result) => {
      // 处理图层数据并更新UI
    });
  }
  ```

#### 导出图层按钮
- **ID**: `export-layers-btn`
- **功能**: 导出选中的图层到文件系统
- **状态管理**: 根据是否有选中图层动态启用/禁用

#### 导出到Eagle按钮
- **ID**: `export-to-eagle-btn`
- **功能**: 将AE图层数据直接导出到Eagle资源库
- **运行逻辑**: 调用Eagle API进行数据传输

## 4. 状态信息面板

### 4.1 导入状态显示
- **ID**: `import-status`
- **状态类型**:
  - `idle`: 等待状态
  - `processing`: 处理中（带脉冲动画）
  - `success`: 成功完成
  - `error`: 错误状态

### 4.2 状态消息
- **ID**: `latest-log-message`
- **功能**: 显示最新的操作状态信息
- **更新机制**: 实时更新最新的日志消息

## 5. 日志面板

### 5.1 日志标题栏
- **ID**: `log-title`
- **功能**: 显示当前日志源（AE扩展/Eagle插件）
- **交互**: 点击切换日志源

### 5.2 日志控制按钮
- **ID**: `clear-log-btn`
- **图标**: 🗑️
- **功能**: 清空当前显示的日志内容

### 5.3 日志输出区域
- **ID**: `log-output`
- **功能**: 显示实时日志信息
- **格式**: 时间戳 + 级别 + 消息内容
- **自动滚动**: 新消息自动滚动到底部

## 6. 模态对话框组件

### 6.1 文件夹选择器
- **ID**: `folder-picker-modal`
- **功能**: 选择目标文件夹
- **支持方式**:
  - 拖拽选择
  - 手动输入路径
  - 浏览器文件夹选择API

### 6.2 高级设置面板
- **ID**: `settings-panel`
- **包含设置**:
  - 导入模式配置
  - 导入行为配置
  - 导出路径设置
  - 通信设置

### 6.3 项目旁复制设置
- **ID**: `project-adjacent-modal`
- **功能**: 配置项目旁复制的文件夹名称

## 7. 图层检测弹窗组件

### 7.1 图层检测总结对话框

#### 对话框结构
- **类型**: ExtendScript Panel样式对话框
- **标题**: "图层检测总结"
- **尺寸**: 自适应内容，最大高度400像素
- **布局**: 垂直排列，包含统计信息和图层列表

#### 统计信息区域
- **可导出统计**: 显示可导出图层数量和类型分布
- **不可导出统计**: 显示不可导出图层的原因分类
- **总体概览**: 三行总结格式，简洁明了

### 7.2 图层操作按钮组

#### 7.2.1 文件夹打开按钮

**基本信息**:
- **函数**: `addOpenFolderButton(parent, layer)`
- **图标**: `▶` (右箭头符号)
- **尺寸**: 25x18像素
- **位置**: 每个图层行的右侧
- **提示文本**: "打开文件所在文件夹"

**功能特性**:
- **路径获取**: 支持多种路径源（tooltipInfo、sourceInfo、source.file等）
- **编码处理**: 使用URI解码解决中文路径问题
- **打开方式**: JSX原生Folder对象 + Windows Explorer备用
- **错误处理**: 智能错误诊断和用户友好提示

**图标演进**:
```
v1.0: 📁 (表情符号) → 兼容性问题
v1.1: [...] (方括号) → 过于简单
v2.0: ▶ (右箭头) → 兼容且美观
```

**技术实现**:
```javascript
// 按钮创建
var openBtn = parent.add('button', undefined, '▶');
openBtn.preferredSize.width = 25;
openBtn.preferredSize.height = 18;
openBtn.helpTip = '打开文件所在文件夹';

// 点击事件
openBtn.onClick = function() {
    try {
        openLayerFolder(layer);
    } catch (error) {
        console.error('[打开文件夹按钮错误] ' + error.message);
    }
};
```

**路径处理流程**:
1. **路径获取**: 按优先级从图层对象获取文件路径
2. **URI解码**: 使用`decodeStr()`处理中文编码
3. **路径验证**: 检查路径格式和编码问题
4. **文件夹解析**: 提取文件夹路径（去除文件名）
5. **打开执行**: 使用JSX原生方法或备用方案
6. **结果反馈**: 成功提示或错误诊断

#### 7.2.2 扩展功能按钮

**基本信息**:
- **函数**: `addExtensionButton(parent, layer, canExport)`
- **图标**: `◈` (菱形符号)
- **尺寸**: 25x18像素
- **状态**: 当前禁用，预留扩展
- **提示文本**: "扩展功能（预留）"

**预留功能**:
- 图层详细信息查看
- 图层属性编辑
- 批量操作选项
- 自定义导出设置

### 7.3 悬浮提示系统

#### 7.3.1 图层悬浮提示 (addLayerTooltip)

**功能**: 为图层元素添加详细的悬浮提示信息

**提示内容**:
- **基本信息**: 图层类型、导出状态
- **路径信息**: 文件原始路径（优先显示）
- **文件信息**: 大小、修改时间、尺寸、时长
- **调试信息**: 开发模式下的详细调试数据

**数据源优先级**:
1. `layer.tooltipInfo` - Demo模式虚拟数据
2. `layer.sourceInfo` - 源文件信息
3. `layer.source.file` - AE原生文件对象
4. `layer.originalPath` - 备用路径属性

#### 7.3.2 错误处理和降级

**错误类型**:
- **路径编码错误**: 检测问号字符，提供编码修复建议
- **文件夹不存在**: 验证路径有效性，提供手动操作指导
- **权限问题**: 检测访问权限，提供权限设置建议
- **系统兼容性**: JSX方法失败时自动降级到系统命令

**用户指导**:
- **编码问题**: 重命名文件避免特殊字符
- **路径问题**: 检查文件位置和格式
- **权限问题**: 确认文件夹访问权限
- **手动操作**: 提供路径复制和手动导航指导
- **预设选项**: Eagle_Assets, Eagle_Import, Source_Files等

### 6.4 指定文件夹设置
- **ID**: `custom-folder-modal`
- **功能**: 配置自定义文件夹路径
- **特性**: 支持最近使用文件夹记录

## 7. 拖拽导入功能

### 7.1 拖拽检测
- **触发区域**: 整个插件面板
- **视觉反馈**: 蒙版效果 + 边框动画
- **提示信息**: 中央显示拖拽提示

### 7.2 拖拽状态管理
```javascript
// 拖拽状态类
body.drag-over {
  // 应用拖拽样式
}

// 拖拽动画
@keyframes dragPulse {
  from { opacity: 0.3; }
  to { opacity: 0.7; }
}
```

## 8. 响应式设计

### 8.1 断点设置
- **大尺寸**: > 400px
- **中等尺寸**: 321px - 400px
- **小尺寸**: 280px - 320px
- **极小尺寸**: < 280px

### 8.2 自适应调整
- **按钮尺寸**: 根据屏幕大小调整padding和字体
- **间距优化**: 小屏幕下减少间距
- **文字大小**: 动态调整以保持可读性

## 9. 数据流向和交互逻辑

### 9.1 设置同步机制
```javascript
// 快速面板 → 高级设置
syncQuickToAdvanced() {
  // 同步导入模式和行为设置
}

// 高级设置 → 快速面板
syncAdvancedToQuick() {
  // 反向同步设置
}
```

### 9.2 数据持久化
- **存储方式**: localStorage
- **存储内容**: 用户设置、最近使用路径
- **恢复机制**: 页面加载时自动恢复设置

### 9.3 错误处理机制
- **连接错误**: 自动重试机制
- **文件操作错误**: 友好错误提示
- **设置验证**: 输入验证和格式检查

## 10. 性能优化特性

### 10.1 动画优化
- **CSS动画**: 使用transform和opacity避免重排
- **节流处理**: 拖拽事件节流处理
- **内存管理**: 及时清理事件监听器

### 10.2 异步处理
- **文件操作**: 异步处理避免UI阻塞
- **网络请求**: Promise-based异步通信
- **状态更新**: 批量更新减少DOM操作

## 11. 安全性考虑

### 11.1 路径验证
- **输入验证**: 防止路径注入攻击
- **权限检查**: 确保文件访问权限
- **错误信息**: 不暴露敏感系统信息

### 11.2 数据保护
- **本地存储**: 仅存储必要的配置信息
- **传输安全**: 本地通信避免网络风险
- **临时文件**: 及时清理临时数据

---

## 开发者注意事项

1. **组件独立性**: 每个组件应保持功能独立，便于维护
2. **状态管理**: 使用统一的状态管理机制
3. **错误处理**: 所有用户操作都应有适当的错误处理
4. **可访问性**: 确保键盘导航和屏幕阅读器支持
5. **测试覆盖**: 关键交互功能需要充分测试

## 相关文档

- [API参考文档](./api-reference.md)
- [开发指南](../development/setup-guide.md)
- [架构设计](../architecture/system-design.md)
- [通信协议](../../shared/communication-protocol.md)